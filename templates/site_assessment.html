<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Site Assessment - {{ permit.permit_ref }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      color-scheme: dark;
      --bg: #0a192a;
      --panel: #132b40;
      --panel-alt: #102233;
      --text: #f2f7ff;
      --muted: #8ea2ba;
      --accent: #2b7cff;
      --border: rgba(255,255,255,0.08);
      --border-strong: rgba(43,124,255,0.45);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(195deg, rgba(43,124,255,0.08), transparent 60%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 2rem;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-weight: 600;
      font-size: 0.85rem;
    }
    .brand span {
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      border: 1px solid var(--border-strong);
      background: rgba(43,124,255,0.12);
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
    }
    .nav-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      padding: 0.45rem 1rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.08);
      color: var(--text);
      text-decoration: none;
      font-size: 0.85rem;
      transition: background 0.15s ease, border-color 0.15s ease;
    }
    .nav-btn:hover {
      background: rgba(43,124,255,0.2);
      border-color: var(--border-strong);
    }
    main {
      width: 100%;
      max-width: 1024px;
      margin: 2.3rem auto 3rem;
      padding: 0 1.75rem 3rem;
      flex: 1;
      display: grid;
      gap: 1.75rem;
    }
    h1 {
      margin: 0;
      font-size: 1.9rem;
      font-weight: 600;
    }
    .subtitle {
      margin: 0.3rem 0 0;
      color: var(--muted);
      font-size: 1rem;
    }
    form {
      background: var(--panel);
      border-radius: 20px;
      border: 1px solid var(--border);
      padding: 1.9rem;
      box-shadow: 0 18px 45px rgba(9, 22, 40, 0.45);
      display: grid;
      gap: 1.4rem;
    }
    .section-title {
      margin: 0;
      font-size: 1.12rem;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    .grid {
      display: grid;
      gap: 1rem 1.4rem;
    }
    .grid.two {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    .grid.three {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
    label {
      display: block;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: rgba(255,255,255,0.7);
      margin-bottom: 0.35rem;
    }
    input[type="text"],
    input[type="tel"],
    input[type="email"],
    input[type="date"],
    textarea,
    select {
      width: 100%;
      padding: 0.65rem 0.85rem;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: var(--panel-alt);
      color: var(--text);
      font-size: 0.95rem;
    }
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: rgba(43,124,255,0.6);
      box-shadow: 0 0 0 2px rgba(43,124,255,0.16);
    }
    .radio-group,
    .inline-group {
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
      font-size: 0.9rem;
    }
    .radio-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.45rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      cursor: pointer;
      font-size: 0.85rem;
    }
    .radio-pill input {
      margin: 0;
    }
    .question-table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      overflow: hidden;
      background: rgba(8,20,34,0.8);
    }
    .question-table th,
    .question-table td {
      padding: 0.65rem 0.8rem;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      text-align: left;
      font-size: 0.9rem;
    }
    .question-table th {
      background: rgba(255,255,255,0.05);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(255,255,255,0.75);
    }
    .answer-options {
      display: flex;
      gap: 0.7rem;
      flex-wrap: wrap;
      font-size: 0.85rem;
    }
    .answer-options label {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      margin: 0;
      font-size: 0.85rem;
      text-transform: none;
      letter-spacing: normal;
      color: var(--text);
    }
    .question-group-row td {
      padding: 0.65rem 0.8rem;
      background: rgba(43,124,255,0.08);
      color: var(--text);
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    .attachment-grid {
      display: grid;
      gap: 1.2rem;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    .attachment-card {
      background: var(--panel-alt);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1rem 1.1rem;
      display: grid;
      gap: 0.75rem;
    }
    .attachment-card label span {
      font-size: 0.82rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.75);
    }
    .attachment-card input[type="file"] {
      border: 1px dashed rgba(255,255,255,0.18);
      border-radius: 12px;
      padding: 0.85rem;
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      cursor: pointer;
    }
    .attachment-existing {
      display: grid;
      gap: 0.55rem;
    }
    .attachment-preview {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .attachment-preview img {
      width: 68px;
      height: 68px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
    }
    .attachment-meta {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      font-size: 0.84rem;
    }
    .attachment-meta a {
      color: var(--text);
      text-decoration: none;
    }
    .attachment-meta span {
      font-size: 0.74rem;
      color: rgba(255,255,255,0.55);
    }
    .attachment-empty {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.5);
    }
    .muted-text {
      font-size: 0.85rem;
      color: var(--muted);
      margin: 0;
    }
    .notes-text {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.65);
    }
    .results-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
    .results-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 0.9rem;
      display: grid;
      gap: 0.6rem;
    }
    .form-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      align-items: center;
    }
    .primary-btn {
      padding: 0.78rem 1.6rem;
      border: 0;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(43,124,255,0.9), rgba(22,102,175,0.88));
      color: var(--text);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      box-shadow: 0 18px 42px rgba(26,78,148,0.5);
      transition: transform 0.16s ease, box-shadow 0.16s ease;
    }
    .primary-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 22px 48px rgba(26,78,148,0.6);
    }
    .secondary-link {
      color: var(--muted);
      text-decoration: none;
      font-size: 0.9rem;
    }
    .secondary-link:hover {
      color: var(--text);
    }
    .flash-list {
      display: grid;
      gap: 0.6rem;
    }
    .flash {
      padding: 0.75rem 1rem;
      border-radius: 12px;
      font-size: 0.9rem;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.08);
    }
    .supporting-info {
      display: grid;
      gap: 0.4rem;
      font-size: 0.88rem;
      color: var(--muted);
    }
    @media (max-width: 700px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.9rem;
        padding: 1.1rem 1.4rem;
      }
      main {
        padding: 0 1.25rem 2.5rem;
      }
      form {
        padding: 1.4rem;
      }
      .question-table th,
      .question-table td {
        font-size: 0.82rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span>GeoProx</span>
      <div>Site assessment</div>
    </div>
    <div class="actions">
      <a class="nav-btn" href="/permits/{{ permit.permit_ref | urlencode }}/view">Back to permit</a>
      <a class="nav-btn" href="/dashboard">Dashboard</a>
      <a class="nav-btn" href="/app">Desktop check</a>
    </div>
  </header>
  <main>
    <section>
      <h1>Site assessment for {{ permit.permit_ref }}</h1>
      <p class="subtitle">Record the on-site waste assessment so it can be referenced alongside the desktop proximity report.</p>
    </section>

    {% if flashes %}
    <div class="flash-list">
      {% for flash in flashes %}
      <div class="flash flash-{{ flash.category }}">{{ flash.message }}</div>
      {% endfor %}
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" novalidate>
      <div class="supporting-info">
        <div>Status: {{ site_status or 'Not started' }}</div>
        {% set saved_bituminous = form_defaults.get('result_bituminous') %}
        {% set saved_sub_base = form_defaults.get('result_sub_base') %}
        {% if saved_bituminous or saved_sub_base %}
        <div>Latest results: Bituminous {{ saved_bituminous or '-' }}, Sub-base {{ saved_sub_base or '-' }}</div>
        {% endif %}
        {% if site_pdf_url %}
        <div>Latest report: <a href="{{ site_pdf_url }}" target="_blank" rel="noopener">Download current site PDF</a></div>
        {% endif %}
        {% if site_notes %}<div>Previous notes: {{ site_notes }}</div>{% endif %}
      </div>

      <div>
        <h2 class="section-title">Site details</h2>
        <div class="grid two">
          <div>
            <label for="utility_type">Utility type</label>
            <input id="utility_type" name="utility_type" type="text" value="{{ form_defaults.get('utility_type', '') }}" placeholder="Example: Power, Gas, Street Lighting">
          </div>
          <div>
            <label for="assessment_date">Date of assessment</label>
            <input id="assessment_date" name="assessment_date" type="date" value="{{ form_defaults.get('assessment_date', today) }}">
          </div>
          <div>
            <label>Location of work</label>
            <div class="radio-group">
              {% for option in location_options %}
              {% set selected_location = form_defaults.get('location_of_work') %}
              {% set checked = 'checked' if selected_location == option or (not selected_location and loop.first) else '' %}
              <label class="radio-pill">
                <input type="radio" name="location_of_work" value="{{ option }}" {{ checked }}>
                {{ option }}
              </label>
              {% endfor %}
            </div>
          </div>
          <div>
            <label for="permit_number">Permit number</label>
            <input id="permit_number" name="permit_number" type="text" value="{{ form_defaults.get('permit_number', permit.permit_ref) }}">
          </div>
          <div>
            <label for="work_order_ref">Work order reference</label>
            <input id="work_order_ref" name="work_order_ref" type="text" value="{{ form_defaults.get('work_order_ref', '') }}">
          </div>
          <div>
            <label for="excavation_site_number">Excavation site number</label>
            <input id="excavation_site_number" name="excavation_site_number" type="text" value="{{ form_defaults.get('excavation_site_number', '') }}">
          </div>
          <div>
            <label for="site_address">Address</label>
            <input id="site_address" name="site_address" type="text" value="{{ form_defaults.get('site_address', permit.location.display or '') }}">
          </div>
          <div>
            <label for="site_postcode">Post code</label>
            <input id="site_postcode" name="site_postcode" type="text" value="{{ form_defaults.get('site_postcode', '') }}">
          </div>
          <div>
            <label for="highway_authority">Highway authority</label>
            <input id="highway_authority" name="highway_authority" type="text" value="{{ form_defaults.get('highway_authority', '') }}">
          </div>
          <div>
            <label for="works_type">Works type</label>
            <select id="works_type" name="works_type">
              <option value="">Select works type</option>
              {% for option in works_type_options %}
              <option value="{{ option }}" {% if form_defaults.get('works_type') == option %}selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label>Surface location</label>
            <div class="radio-group">
              {% for option in surface_options %}
              {% set checked = 'checked' if form_defaults.get('surface_location', '').startswith(option) else '' %}
              <label class="radio-pill">
                <input type="radio" name="surface_location" value="{{ option }}" {{ checked }}>
                {{ option }}
              </label>
              {% endfor %}
            </div>
            <input id="surface_location_other" name="surface_location_other" type="text" value="{{ form_defaults.get('surface_location_other', '') }}" placeholder="If other, describe">
          </div>
          <div>
            <label for="what_three_words">Optional what three words</label>
            <input id="what_three_words" name="what_three_words" type="text" value="{{ form_defaults.get('what_three_words', '') }}" placeholder="word.word.word">
          </div>
        </div>
      </div>

      <div>
        <h2 class="section-title">Questionnaire</h2>
        {% set counter = namespace(value=0) %}
        <table class="question-table">
          <thead>
            <tr>
              <th style="width: 3rem;">Ref</th>
              <th>Question</th>
              <th style="width: 13rem;">Answer</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            {% for section_title, rows in question_sections %}
            <tr class="question-group-row">
              <td colspan="4">{{ section_title }}</td>
            </tr>
            {% for key, question, note in rows %}
            {% set counter.value = counter.value + 1 %}
            {% set selected = form_defaults.get(key, '') %}
            <tr>
              <td>Q{{ counter.value }}</td>
              <td>{{ question }}</td>
              <td>
                <div class="answer-options">
                  <label><input type="radio" name="{{ key }}" value="Yes" {% if selected == 'Yes' %}checked{% endif %}> Yes</label>
                  <label><input type="radio" name="{{ key }}" value="No" {% if selected == 'No' %}checked{% endif %}> No</label>
                  {% if key in yes_no_na_keys %}
                  <label><input type="radio" name="{{ key }}" value="N/A" {% if selected == 'N/A' %}checked{% endif %}> N/A</label>
                  {% endif %}
                </div>
              </td>
              <td class="notes-text">{{ note }}</td>
            </tr>
            {% endfor %}
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div>
        <h2 class="section-title">Assessment results</h2>
        <div class="results-grid">
          {% for key, label in result_meta %}
          {% set selected = form_defaults.get(key, '') %}
          <div class="results-card">
            <strong>{{ label }}</strong>
            <div class="answer-options">
              {% for option in result_choices %}
              <label><input type="radio" name="{{ key }}" value="{{ option }}" {% if selected == option %}checked{% endif %}> {{ option }}</label>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <div>
        <h2 class="section-title">Photo evidence</h2>
        <p class="muted-text">Capture supporting photos for the inspection (you can take a picture or choose from your library).</p>
        <div class="attachment-grid">
          {% for category_key, category_label in attachment_categories %}
          <div class="attachment-card">
            <div>
              <label for="attachment_{{ category_key }}"><span>{{ category_label }}</span></label>
              <input type="file" id="attachment_{{ category_key }}" name="attachment_{{ category_key }}" accept="image/*" capture="environment" multiple>
            </div>
            {% set existing = attachments_grouped.get(category_key, []) %}
            {% if existing %}
            <div class="attachment-existing">
              {% for item in existing %}
              <div class="attachment-preview">
                <a href="{{ item.url }}" target="_blank" rel="noopener">
                  <img src="{{ item.url }}" alt="{{ item.filename or ('Attachment ' ~ loop.index) }}">
                </a>
                <div class="attachment-meta">
                  <a href="{{ item.url }}" target="_blank" rel="noopener">{{ item.filename or ('Attachment ' ~ loop.index) }}</a>
                  {% if item.uploaded_at_display %}<span>{{ item.uploaded_at_display }}</span>{% elif item.uploaded_at %}<span>{{ item.uploaded_at|replace('T', ' ')|replace('Z', ' UTC') }}</span>{% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <p class="attachment-empty">No {{ category_label|lower }} uploaded yet.</p>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="grid two">
        <div>
          <label for="assessor_name">Assessor name</label>
          <input id="assessor_name" name="assessor_name" type="text" value="{{ form_defaults.get('assessor_name', '') }}">
        </div>
        <div>
          <label for="site_status">Site assessment status</label>
          <select id="site_status" name="site_status">
            {% for value, label in status_options %}
            <option value="{{ value }}" {% if (site_status or '') == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="site_notes">Additional notes</label>
          <textarea id="site_notes" name="site_notes" placeholder="Observations, follow-up actions or attachments">{{ form_defaults.get('site_notes', site_notes or '') }}</textarea>
        </div>
      </div>

      <div class="form-actions">
        <button class="primary-btn" type="submit">Save site assessment</button>
        <a class="secondary-link" href="/permits/{{ permit.permit_ref | urlencode }}/view">Cancel and return to permit</a>
      </div>
    </form>
  </main>
</body>
</html>

