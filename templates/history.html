<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>GeoProx - History</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/css/geoprox-theme.css">
</head>
<body>
  <div class="gp-app">
    <header class="gp-header">
      <div class="gp-header-title">
        <img src="/static/geoprox-logo.png" alt="GeoProx logo" style="height:32px">
        <span>Search History</span>
      </div>
      <nav class="gp-nav">
        <a class="gp-btn gp-btn-outline" href="/app">Back to app</a>
        {% set export_limit = items|length %}
        <a class="gp-btn gp-btn-outline" href="/history/export{% if export_limit %}?limit={{ export_limit }}{% endif %}" download>Download CSV</a>
        <a class="gp-btn gp-btn-outline" href="/change-password">Change password</a>
        {% if is_admin %}<a class="gp-btn gp-btn-outline" href="/admin/users">Manage users</a>{% endif %}
        <form method="post" action="/logout">
          <button class="gp-btn gp-btn-outline" type="submit">Sign out</button>
        </form>
      </nav>
    </header>

    <main class="gp-main">
      <section class="gp-section headerless">
        <div class="gp-muted">Signed in as {{ user }} &mdash; {{ user_type_label }}</div>
        {% if not allow_desktop %}
        <div class="gp-muted" style="margin-top:0.5rem">Desktop searches must be completed by a desktop user. You can review existing searches from your company.</div>
        {% endif %}
        {% if has_company_scope %}
        <div class="gp-muted" style="margin-top:0.5rem">Showing searches from {{ visible_usernames | join(', ') }}.</div>
        {% endif %}

        {% if items %}
        <table class="gp-table" style="margin-top:1.5rem">
          <thead>
            <tr>
              <th>When</th>
              <th>Location</th>
              <th>Radius (m)</th>
              <th>Outcome</th>
              <th>Permit</th>
              <th>Created By</th>
              <th>Artifacts</th>
            </tr>
          </thead>
          <tbody>
            {% for row in items %}
            <tr>
              <td>{{ row.timestamp_display }}</td>
              <td>{{ row.location }}</td>
              <td>{{ row.radius_m }}</td>
              <td>
                {% if row.outcome %}
                  {% set status = row.outcome|lower %}
                  <span class="gp-chip status-{{ status }}">{{ row.outcome|upper }}</span>
                {% else %}
                  <span class="gp-muted">-</span>
                {% endif %}
              </td>
              <td>{{ row.permit or '-' }}</td>
              <td>
                {% if row.owner_username %}
                  <span{% if row.owner_display_name and row.owner_display_name != row.owner_username %} title="{{ row.owner_display_name }}"{% endif %}>{{ row.owner_username }}</span>
                {% else %}
                  <span class="gp-muted">-</span>
                {% endif %}
              </td>
              <td>
                {% set pdf = row.pdf_path %}
                {% set map = row.map_path %}
                {% if pdf %}
                  <a class="gp-link" href="{{ pdf }}" target="_blank" rel="noopener">PDF</a>
                {% endif %}
                {% if pdf and map %}
                  <span class="gp-muted">|</span>
                {% endif %}
                {% if map %}
                  <a class="gp-link" href="{{ map }}" target="_blank" rel="noopener">Map</a>
                {% endif %}
                {% if not pdf and not map %}
                  <span class="gp-muted">None</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="gp-muted" style="margin-top:2rem">No searches recorded yet.</div>
        {% endif %}
      </section>
    </main>

    <footer class="gp-footer">
      Need older records? Contact useradmin@geoprox.co.uk
    </footer>
  </div>
</body>
</html>
