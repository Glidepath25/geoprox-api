<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>GeoProx - User Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/css/geoprox-theme.css">
</head>
<body>
  <div class="gp-app">
    <header class="gp-header">
      <div class="gp-header-title">
        <img src="/static/geoprox-logo.png" alt="GeoProx logo" style="height:32px">
        <span>User management</span>
      </div>
      <nav class="gp-nav">
        <a class="gp-btn gp-btn-outline" href="/app">Back to app</a>
        <a class="gp-btn gp-btn-outline" href="/history">History</a>
        <a class="gp-btn gp-btn-outline" href="/admin/reports/unidentified">Unidentified reports</a>
        <a class="gp-btn gp-btn-outline" href="/admin/users/export.csv">Download users CSV</a>
        <form method="post" action="/logout">
          <button class="gp-btn gp-btn-outline" type="submit">Sign out</button>
        </form>
      </nav>
    </header>

    <main class="gp-main">
      {% if flashes %}
      <section class="gp-section">
        {% for flash in flashes %}
          {% set category = flash.category or 'info' %}
          <div class="gp-flash {{ 'success' if category == 'success' else 'error' if category == 'error' else 'info' }}">{{ flash.message }}</div>
        {% endfor %}
      </section>
      {% endif %}

      {% if is_global_admin %}
      <section class="gp-section gp-collapsible" data-collapsible data-start-collapsed="true">
        <div class="gp-collapsible-header">
          <h2 class="gp-collapsible-title">Manage companies</h2>
          <button type="button" class="gp-toggle" aria-expanded="false">Show</button>
        </div>
        <div class="gp-collapsible-body">
          <div class="gp-muted gp-small">Companies define the scope that company admins can manage. Create or update records here.</div>
          <form class="gp-form" method="post" action="/admin/companies">
            <div class="gp-form-grid">
              <div class="gp-form-group">
                <label for="company_name">Company</label>
                <input id="company_name" name="name" type="text" placeholder="Company name" required>
              </div>
              <div class="gp-form-group">
                <label for="company_number">Company number</label>
                <input id="company_number" name="company_number" type="text" placeholder="Companies House number (optional)">
              </div>
              <div class="gp-form-group">
                <label for="company_phone">Phone</label>
                <input id="company_phone" name="phone" type="text" placeholder="Main contact number">
              </div>
              <div class="gp-form-group">
                <label for="company_email">Email</label>
                <input id="company_email" name="email" type="email" placeholder="Billing or admin email">
              </div>
            </div>
            <div class="gp-form-group">
              <label for="company_notes">Notes</label>
              <textarea id="company_notes" name="notes" placeholder="Optional internal notes"></textarea>
            </div>
            <div class="gp-form-actions">
              <button class="gp-btn" type="submit">Create company</button>
            </div>
          </form>

          {% if companies %}
          <table class="gp-table" style="margin-top:1.5rem">
            <thead>
              <tr>
                <th>Company</th>
                <th>Company number</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Status</th>
                <th>Notes</th>
                <th style="width:240px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for company in companies %}
              <tr>
                <td>{{ company.name }}</td>
                <td>{{ company.company_number or '-' }}</td>
                <td>{{ company.phone or '-' }}</td>
                <td>{{ company.email or '-' }}</td>
                <td>
                  <span class="gp-badge {{ 'green' if company.is_active else 'red' }}">
                    {{ 'Active' if company.is_active else 'Inactive' }}
                  </span>
                </td>
                <td>{{ company.notes or '-' }}</td>
                <td>
                  <form class="gp-inline-form" method="post" action="/admin/companies/{{ company.id }}/update">
                    <input type="hidden" name="redirect_company_id" value="{{ selected_company or '' }}">
                    <input name="name" type="text" value="{{ company.name }}" placeholder="Company name">
                    <input name="phone" type="text" value="{{ company.phone }}" placeholder="Phone">
                    <input name="email" type="email" value="{{ company.email }}" placeholder="Email">
                    <select name="is_active">
                      <option value="true" {% if company.is_active %}selected{% endif %}>Active</option>
                      <option value="false" {% if not company.is_active %}selected{% endif %}>Inactive</option>
                    </select>
                    <button class="gp-btn gp-btn-outline" type="submit">Update</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="gp-table-note" style="margin-top:1rem">No companies created yet.</div>
          {% endif %}
        </div>
      </section>
      {% endif %}

      <section class="gp-section gp-collapsible" data-collapsible>
        <div class="gp-collapsible-header">
          <h2 class="gp-collapsible-title">Add user</h2>
          <button type="button" class="gp-toggle" aria-expanded="true">Hide</button>
        </div>
        <div class="gp-collapsible-body">
          <form class="gp-form" method="post" action="/admin/users/create">
            <input type="hidden" name="redirect_company_id" value="{{ selected_company or '' }}">
            <div class="gp-form-grid">
              <div class="gp-form-group">
                <label for="user_username">Username</label>
                <input id="user_username" name="username" type="text" required placeholder="unique login">
              </div>
              <div class="gp-form-group">
                <label for="user_password">Temporary password</label>
                <input id="user_password" name="password" type="password" minlength="8" autocomplete="new-password" required>
              </div>
            </div>
            <div class="gp-form-grid">
              <div class="gp-form-group">
                <label for="user_name">Display name</label>
                <input id="user_name" name="name" type="text" required>
              </div>
              <div class="gp-form-group">
                <label for="user_email">Email</label>
                <input id="user_email" name="email" type="email" placeholder="Optional">
              </div>
              <div class="gp-form-group">
                <label for="user_phone">Phone</label>
                <input id="user_phone" name="phone" type="text" placeholder="Optional">
              </div>
              <div class="gp-form-group">
                <label for="user_company">Company label</label>
                <input id="user_company" name="company" type="text" placeholder="Visible on reports">
              </div>
            </div>
            <div class="gp-form-grid">
              <div class="gp-form-group">
                <label for="user_license_tier">License tier</label>
                <select id="user_license_tier" name="license_tier">
                  {% for key, meta in license_tiers.items() %}
                    <option value="{{ key }}" {% if key == default_license_tier %}selected{% endif %}>{{ meta['label'] }}</option>
                  {% endfor %}
                </select>
                <div class="gp-note">Determines the monthly search allocation.</div>
              </div>
              <div class="gp-form-group">
                <label for="user_type">User type</label>
                <select id="user_type" name="user_type">
                  {% for key, label in user_types.items() %}
                    <option value="{{ key }}" {% if key == default_user_type %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              {% if is_global_admin %}
              <div class="gp-checkbox" style="margin-top:1.8rem">
                <input type="checkbox" id="user_is_admin" name="is_admin">
                <label for="user_is_admin">Platform administrator</label>
              </div>
              <div class="gp-checkbox" style="margin-top:1.8rem">
                <input type="checkbox" id="user_is_company_admin" name="is_company_admin">
                <label for="user_is_company_admin">Company administrator</label>
              </div>
              {% endif %}
            </div>
            <div class="gp-form-actions">
              <button class="gp-btn" type="submit">Create user</button>
            </div>
          </form>
        </div>
      </section>

      <section class="gp-section gp-collapsible" data-collapsible>
        <div class="gp-collapsible-header">
          <h2 class="gp-collapsible-title">Existing users</h2>
          <button type="button" class="gp-toggle" aria-expanded="true">Hide</button>
        </div>
        <div class="gp-collapsible-body">
          <form class="gp-filter-bar" method="get" action="/admin/users">
            {% if is_global_admin %}
            <div class="gp-form-group">
              <label for="filter_company">Filter by company</label>
              <select id="filter_company" name="company_id" onchange="this.form.submit()">
                <option value="">All companies</option>
                {% for company in companies %}
                  <option value="{{ company.id }}" {% if selected_company == company.id %}selected{% endif %}>{{ company.name }}</option>
                {% endfor %}
              </select>
            </div>
            {% else %}
            <div class="gp-form-group">
              <label>Company</label>
              <div class="gp-muted">{{ managed_company.name if managed_company else "Unassigned" }}</div>
            </div>
            {% endif %}
            <div class="gp-checkbox">
              <input type="checkbox" id="filter_active" name="active_only" value="1" {% if active_only %}checked{% endif %} onchange="this.form.submit()">
              <label for="filter_active">Active only</label>
            </div>
          </form>

          {% if users %}
          <table class="gp-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Name</th>
                <th>Email</th>
                <th>Company</th>
                <th>License</th>
                <th>User type</th>
                <th>Role</th>
                <th>Status</th>
                <th>Searches</th>
                <th style="width:320px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for user in users %}
              <tr>
                <td>{{ user.username }}</td>
                <td>{{ user.name }}</td>
                <td>{{ user.email or '-' }}</td>
                <td>{{ user.company or 'Unassigned' }}</td>
                <td>
                  {% set tier_key = user.license_tier or user_store.DEFAULT_LICENSE_TIER %}
                  {% set tier_meta = license_tiers.get(tier_key, {}) %}
                  {% set monthly_limit = tier_meta.get('monthly_limit') %}
                  {% set monthly_used = monthly_counts.get(user.username, 0) %}
                  <span>{{ tier_meta.get('label', tier_key|capitalize) }}</span>
                  <div class="gp-note">
                    {% if monthly_limit is none %}
                      {{ monthly_used }} this month
                    {% else %}
                      {{ monthly_used }} / {{ monthly_limit }} this month
                    {% endif %}
                  </div>
                </td>
                <td>{{ user_types.get(user.user_type, user.user_type | title) }}</td>
                <td>{{ 'Platform admin' if user.is_admin else ('Company admin' if user.is_company_admin else 'User') }}</td>
                <td>
                  <span class="gp-badge {{ 'green' if user.is_active else 'red' }}">{{ 'Active' if user.is_active else 'Disabled' }}</span>
                  {% if user.require_password_change %}
                  <div class="gp-note">Password change required</div>
                  {% endif %}
                </td>
                <td>{{ search_counts.get(user.username, 0) }}</td>
                <td>
                  <div class="gp-table-actions">
                    <form method="post" action="/admin/users/{{ user.id }}/toggle">
                      <input type="hidden" name="redirect_company_id" value="{{ selected_company or '' }}">
                      <button class="gp-btn gp-btn-outline" type="submit">
                        {{ 'Disable' if user.is_active else 'Enable' }}
                      </button>
                    </form>
                    <form method="post" action="/admin/users/{{ user.id }}/reset-password">
                      <input type="hidden" name="redirect_company_id" value="{{ selected_company or '' }}">
                      <button class="gp-btn gp-btn-outline" type="submit">Reset password</button>
                    </form>
                    <form method="post" action="/admin/users/{{ user.id }}/delete" onsubmit="return confirm('Delete user {{ user.username }}? This cannot be undone.');">
                      <input type="hidden" name="redirect_company_id" value="{{ selected_company or '' }}">
                      <button class="gp-btn gp-btn-outline gp-btn-danger" type="submit">Delete</button>
                    </form>
                  </div>
                  <details style="margin-top:0.75rem;">
                    <summary class="gp-muted gp-small" style="cursor:pointer;">Modify account</summary>
                    <form class="gp-inline-form" method="post" action="/admin/users/{{ user.id }}/update">
                      <input type="hidden" name="redirect_company_id" value="{{ selected_company or '' }}">
                      <input name="name" type="text" value="{{ user.name }}" placeholder="Name">
                      <input name="email" type="email" value="{{ user.email }}" placeholder="Email">
                      <input name="phone" type="text" value="{{ user.phone }}" placeholder="Phone">
                      <input name="company" type="text" value="{{ user.company }}" placeholder="Company label">
                      <select name="license_tier">
                        {% for key, meta in license_tiers.items() %}
                          <option value="{{ key }}" {% if user.license_tier == key %}selected{% endif %}>{{ meta['label'] }}</option>
                        {% endfor %}
                      </select>
                      <select name="user_type">
                        {% for key, label in user_types.items() %}
                          <option value="{{ key }}" {% if user.user_type == key %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                      </select>
                      {% if is_global_admin %}
                      <div class="gp-checkbox">
                        <input type="checkbox" id="admin_{{ user.id }}" name="is_admin" {% if user.is_admin %}checked{% endif %}>
                        <label for="admin_{{ user.id }}">Platform administrator</label>
                      </div>
                      <div class="gp-checkbox">
                        <input type="checkbox" id="company_admin_{{ user.id }}" name="is_company_admin" {% if user.is_company_admin %}checked{% endif %}>
                        <label for="company_admin_{{ user.id }}">Company administrator</label>
                      </div>
                      {% endif %}
                      <div class="gp-checkbox">
                        <input type="hidden" name="require_password_change" value="off">
                        <input type="checkbox" id="pwreset_{{ user.id }}" name="require_password_change" value="on" {% if user.require_password_change %}checked{% endif %}>
                        <label for="pwreset_{{ user.id }}">Require password change</label>
                      </div>
                      <button class="gp-btn gp-btn-outline" type="submit">Save changes</button>
                    </form>
                  </details>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="gp-table-note" style="margin-top:1rem">No user accounts found for this filter.</div>
          {% endif %}
        </div>
      </section>
    </main>

    <footer class="gp-footer">
      Manage licence allocations, access levels, and password resets for your GeoProx users.
    </footer>
  </div>

  <script>
    document.querySelectorAll('[data-collapsible]').forEach((section) => {
      const header = section.querySelector('.gp-collapsible-header');
      const toggle = section.querySelector('.gp-toggle');
      const body = section.querySelector('.gp-collapsible-body');
      if (!header || !toggle || !body) { return; }
      const startCollapsed = section.dataset.startCollapsed === "true";
      const setState = (collapsed) => {
        section.classList.toggle('collapsed', collapsed);
        body.style.display = collapsed ? 'none' : '';
        toggle.textContent = collapsed ? 'Show' : 'Hide';
        toggle.setAttribute('aria-expanded', (!collapsed).toString());
      };
      setState(startCollapsed);
      const handle = (event) => {
        event.preventDefault();
        const collapsed = body.style.display !== 'none';
        setState(collapsed);
      };
      header.addEventListener('click', (event) => {
        if (event.target !== toggle) {
          handle(event);
        }
      });
      toggle.addEventListener('click', handle);
    });
  </script>
</body>
</html>
