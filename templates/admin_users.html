<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>GeoProx - User Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; background:#0b1724; color:#e6f1ff; margin:0; }
    header { display:flex; justify-content:space-between; align-items:center; padding:1rem 2rem; background:#12263a; }
    header h1 { margin:0; font-size:1.2rem; }
    main { padding:2rem; display:flex; flex-direction:column; gap:1.5rem; }
    .card { background:#12263a; border-radius:12px; padding:1.5rem; }
    .collapsible { position:relative; }
    .collapsible-header { display:flex; justify-content:space-between; align-items:center; gap:1rem; cursor:pointer; }
    .collapsible-header h2 { margin:0; font-size:1rem; letter-spacing:0.04em; text-transform:uppercase; }
    .collapsible-toggle { background:none; border:1px solid rgba(255,255,255,0.25); border-radius:6px; color:#9fb3c7; padding:0.25rem 0.7rem; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.08em; cursor:pointer; }
    .collapsible-toggle:hover { background:rgba(255,255,255,0.08); }
    .collapsible-content { margin-top:1.2rem; }
    .collapsible.collapsed .collapsible-content { display:none; }
    label { display:block; font-size:0.82rem; color:#9fb3c7; margin-bottom:0.25rem; }
    input[type=text], input[type=password], input[type=email], select, textarea {
      width:100%; padding:0.55rem 0.65rem; border-radius:8px; border:1px solid rgba(255,255,255,0.08);
      background:#0f1f31; color:#e6f1ff; margin-bottom:0.7rem;
    }
    input[type=password] { letter-spacing:0.05em; }
    select { min-width:160px; }
    textarea { min-height:72px; resize:vertical; }
    .flex { display:flex; gap:1rem; flex-wrap:wrap; }
    .flex > div { flex:1; min-width:200px; }
    .actions { display:flex; gap:0.6rem; align-items:center; }
    .btn { padding:0.45rem 0.9rem; border-radius:8px; border:1px solid rgba(255,255,255,0.3); background:transparent; color:#e6f1ff; text-decoration:none; cursor:pointer; display:inline-block; }
    .btn.primary { background:#2b7cff; border-color:#2b7cff; color:#fff; }
    .btn.danger { border-color:rgba(255,120,120,0.6); color:#ff9e9e; }
    .btn.success { border-color:rgba(83,232,139,0.4); color:#7ff0c0; }
    .btn.small { padding:0.3rem 0.7rem; font-size:0.82rem; }
    .btn:hover { background:rgba(255,255,255,0.08); }
    .flash { padding:0.75rem 1rem; border-radius:8px; margin-bottom:1rem; }
    .flash.success { background:rgba(46,204,113,0.12); border:1px solid rgba(46,204,113,0.4); }
    .flash.error { background:rgba(231,76,60,0.12); border:1px solid rgba(231,76,60,0.4); }
    .flash.info { background:rgba(52,152,219,0.12); border:1px solid rgba(52,152,219,0.4); }
    table { width:100%; border-collapse:collapse; margin-top:1rem; }
    th, td { padding:0.65rem 0.75rem; border-bottom:1px solid rgba(255,255,255,0.06); text-align:left; vertical-align:top; }
    th { background:#18344d; font-size:0.78rem; text-transform:uppercase; letter-spacing:0.04em; }
    tr.user-summary td { background:#10263b; border-top:1px solid rgba(255,255,255,0.08); }
    tr.user-detail td { background:#0f2237; border-top:1px solid rgba(255,255,255,0.1); border-bottom:1px solid rgba(255,255,255,0.08); }
    .row-divider { height:26px; background:linear-gradient(90deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0) 50%, rgba(255,255,255,0.08) 100%); border-radius:999px; }
    .status-chip { display:inline-block; padding:0.2rem 0.6rem; border-radius:999px; font-size:0.7rem; text-transform:uppercase; }
    .status-active { background:#0b4d27; color:#a3f5cb; }
    .status-disabled { background:#602020; color:#ff9e9e; }
    form.inline { display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end; margin-top:0.75rem; }
    form.inline > div { min-width:160px; flex:1; }
    form.inline label { margin-bottom:0.35rem; }
    .checkbox { display:flex; align-items:center; gap:0.4rem; color:#9fb3c7; font-size:0.82rem; }
    .small-note { font-size:0.78rem; color:#9fb3c7; margin-top:-0.3rem; margin-bottom:0.6rem; }
    .muted { color:#9fb3c7; font-size:0.82rem; }
    .filter-form { display:flex; gap:1rem; align-items:flex-end; margin-bottom:0.75rem; flex-wrap:wrap; }
    .filter-form select { min-width:220px; }
    .table-note { font-size:0.78rem; color:#9fb3c7; }
  </style>
</head>
<body>
  <header>
    <h1>User Management</h1>
    <div class="actions">
      <a class="btn" href="/app">Back to app</a>
      <a class="btn" href="/history">History</a>
      <a class="btn" href="/admin/users/export.csv">Download users CSV</a>
      <form method="post" action="/logout" style="margin:0;">
        <button class="btn" type="submit">Sign out</button>
      </form>
    </div>
  </header>
  <main>
    {% if flashes %}
      {% for flash in flashes %}
        <div class="flash {{ flash.category }}">{{ flash.message }}</div>
      {% endfor %}
    {% endif %}

    <div class="muted">Signed in as {{ current_user }}</div>

    <section class="card collapsible" data-collapsible>
      <div class="collapsible-header">
        <h2>Companies</h2>
        <button type="button" class="collapsible-toggle" aria-expanded="true">Hide</button>
      </div>
      <div class="collapsible-content">
        <form method="post" action="/admin/companies/create" style="margin-bottom:1.2rem;">
          <input type="hidden" name="redirect_company_id" value="{{ selected_company or '' }}">
          <h3 style="margin:0 0 0.8rem 0; font-size:1rem;">Create a company</h3>
          <div class="flex">
            <div>
              <label for="company_name">Name</label>
              <input id="company_name" name="name" type="text" required placeholder="Acme Utilities">
            </div>
            <div>
              <label for="company_number">Company number</label>
              <input id="company_number" name="company_number" type="text" placeholder="NI123456">
            </div>
            <div>
              <label for="company_phone">Phone</label>
              <input id="company_phone" name="phone" type="text" placeholder="+44...">
            </div>
          </div>
          <div class="flex">
            <div>
              <label for="company_email">Email</label>
              <input id="company_email" name="email" type="email" placeholder="contact@example.com">
            </div>
            <div>
              <label for="company_notes">Notes</label>
              <textarea id="company_notes" name="notes" placeholder="Licensing scope, primary contacts..."></textarea>
            </div>
          </div>
          <button class="btn primary" type="submit">Create company</button>
        </form>

        {% if companies %}
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Company #</th>
              <th>Phone</th>
              <th>Email</th>
              <th>Status</th>
              <th>Notes</th>
              <th style="width:220px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for company in companies %}
            <tr>
              <td>{{ company.name }}</td>
              <td>{{ company.company_number or '-' }}</td>
              <td>{{ company.phone or '-' }}</td>
              <td>{{ company.email or '-' }}</td>
              <td>{{ 'Active' if company.is_active else 'Inactive' }}</td>
              <td>{{ company.notes or '-' }}</td>
              <td>
                <form class="inline" method="post" action="/admin/companies/{{ company.id }}/update" style="gap:0.5rem;">
                  <input type="hidden" name="redirect_company_id" value="{{ selected_company or '' }}">
                  <div>
                    <label style="display:none;" for="rename_{{ company.id }}">Rename</label>
                    <input id="rename_{{ company.id }}" name="name" type="text" value="{{ company.name }}">
                  </div>
                  <div>
                    <label style="display:none;" for="rephone_{{ company.id }}">Phone</label>
                    <input id="rephone_{{ company.id }}" name="phone" type="text" value="{{ company.phone }}">
                  </div>
                  <div>
                    <label style="display:none;" for="reemail_{{ company.id }}">Email</label>
                    <input id="reemail_{{ company.id }}" name="email" type="email" value="{{ company.email }}">
                  </div>
                  <div>
                    <select name="is_active">
                      <option value="true" {% if company.is_active %}selected{% endif %}>Active</option>
                      <option value="false" {% if not company.is_active %}selected{% endif %}>Inactive</option>
                    </select>
                  </div>
                  <button class="btn small" type="submit">Update</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
          <p class="table-note">No companies created yet.</p>
        {% endif %}
      </div>
    </section>

    <section class="card collapsible" data-collapsible>
      <div class="collapsible-header">
        <h2>Add user</h2>
        <button type="button" class="collapsible-toggle" aria-expanded="true">Hide</button>
      </div>
      <div class="collapsible-content">
        <form method="post" action="/admin/users/create">
          <input type="hidden" name="redirect_company_id" value="{{ selected_company or '' }}">
          <div class="flex">
            <div>
              <label for="user_username">Username</label>
              <input id="user_username" name="username" type="text" required placeholder="unique login">
            </div>
            <div>
              <label for="user_password">Temporary password</label>
              <input id="user_password" name="password" type="password" minlength="8" autocomplete="new-password" required>
            </div>
          </div>
          <div class="flex">
            <div>
              <label for="user_name">Display name</label>
              <input id="user_name" name="name" type="text" required>
            </div>
            <div>
              <label for="user_email">Email</label>
              <input id="user_email" name="email" type="email">
            </div>
            <div>
              <label for="user_phone">Phone</label>
              <input id="user_phone" name="phone" type="text">
            </div>
          </div>
          <div class="flex">
            <div>
              <label for="user_company">Company</label>
              <select id="user_company" name="company_id">
                <option value="">Unassigned</option>
                {% for company in companies %}
                  <option value="{{ company.id }}">{{ company.name }}</option>
                {% endfor %}
              </select>
              <div class="small-note">Leave blank to detach from a company.</div>
            </div>
            <div>
              <label for="user_company_name">Or create a new company</label>
              <input id="user_company_name" name="company" type="text" placeholder="New company name">
            </div>
            <div>
              <label for="user_company_number">Company number</label>
              <input id="user_company_number" name="company_number" type="text">
            </div>
          </div>
          <div class="flex">
            <div>
              <label for="user_license">License tier</label>
              <select id="user_license" name="license_tier">
                {% for key, meta in license_tiers.items() %}
                  <option value="{{ key }}">{{ meta['label'] }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="checkbox" style="margin-top:1.9rem;">
              <input type="checkbox" id="user_is_admin" name="is_admin">
              <label for="user_is_admin" style="margin-bottom:0;">Administrator</label>
            </div>
          </div>
          <button class="btn primary" type="submit">Create user</button>
        </form>
      </div>
    </section>

    <section class="card collapsible" data-collapsible>
      <div class="collapsible-header">
        <h2>Existing users</h2>
        <button type="button" class="collapsible-toggle" aria-expanded="true">Hide</button>
      </div>
      <div class="collapsible-content">
        <form class="filter-form" method="get" action="/admin/users">
          <div>
            <label for="filter_company">Filter by company</label>
            <select id="filter_company" name="company_id" onchange="this.form.submit()">
              <option value="">All companies</option>
              {% for company in companies %}
                <option value="{{ company.id }}" {% if selected_company == company.id %}selected{% endif %}>{{ company.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="checkbox" style="margin-bottom:0;">
            <input type="checkbox" id="filter_active" name="active_only" value="1" {% if active_only %}checked{% endif %} onchange="this.form.submit()">
            <label for="filter_active" style="margin-bottom:0;">Active only</label>
          </div>
        </form>

        {% if users %}
        <table>
          <thead>
            <tr>
              <th>Username</th>
              <th>Name</th>
              <th>Email</th>
              <th>Company</th>
              <th>License</th>
              <th>Role</th>
              <th>Status</th>
              <th>Searches</th>
              <th style="width:320px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr class="user-summary">
              <td>{{ user.username }}</td>
              <td>{{ user.name }}</td>
              <td>{{ user.email or '-' }}</td>
              <td>{{ user.company or 'Unassigned' }}</td>
              <td>
                {% set tier_key = user.license_tier or user_store.DEFAULT_LICENSE_TIER %}
                {% set tier_meta = license_tiers.get(tier_key, {}) %}
                {% set monthly_limit = tier_meta.get('monthly_limit') %}
                {% set monthly_used = monthly_counts.get(user.username, 0) %}
                <span>{{ tier_meta.get('label', tier_key|capitalize) }}</span>
                <div class="table-note">
                  {% if monthly_limit is none %}
                    {{ monthly_used }} this month
                  {% else %}
                    {{ monthly_used }} / {{ monthly_limit }} this month
                  {% endif %}
                </div>
              </td>
              <td>{{ 'Admin' if user.is_admin else 'User' }}</td>
              <td>
                <span class="status-chip {{ 'status-active' if user.is_active else 'status-disabled' }}">{{ 'Active' if user.is_active else 'Disabled' }}</span>
                {% if user.require_password_change %}
                  <div class="table-note">Password change required</div>
                {% endif %}
              </td>
              <td>{{ search_counts.get(user.username, 0) }}</td>
              <td>
                <form method="post" action="/admin/users/{{ user.id }}/toggle" style="display:inline;">
                  <input type="hidden" name="action" value="{{ 'disable' if user.is_active else 'enable' }}">
                  <input type="hidden" name="redirect_company_id" value="{{ selected_company or '' }}">
                  <button class="btn {{ 'danger' if user.is_active else 'success' }} small" type="submit">
                    {{ 'Disable' if user.is_active else 'Enable' }}
                  </button>
                </form>
                <form method="post" action="/admin/users/{{ user.id }}/reset-password" style="display:inline; margin-left:0.4rem;">
                  <input type="hidden" name="redirect_company_id" value="{{ selected_company or '' }}">
                  <input type="password" name="new_password" placeholder="New password" style="width:160px;" autocomplete="new-password">
                  <button class="btn small" type="submit">Reset</button>
                </form>
                <form method="post" action="/admin/users/{{ user.id }}/delete" style="display:inline; margin-left:0.4rem;" onsubmit="return confirm('Delete {{ user.username }}? This cannot be undone.');">
                  <input type="hidden" name="redirect_company_id" value="{{ selected_company or '' }}">
                  <button class="btn danger small" type="submit">Delete</button>
                </form>
              </td>
            </tr>
            <tr class="user-detail">
              <td colspan="9">
                <form class="inline" method="post" action="/admin/users/{{ user.id }}/update">
                  <input type="hidden" name="redirect_company_id" value="{{ selected_company or '' }}">
                  <div>
                    <label>Name</label>
                    <input name="name" type="text" value="{{ user.name }}">
                  </div>
                  <div>
                    <label>Email</label>
                    <input name="email" type="email" value="{{ user.email }}">
                  </div>
                  <div>
                    <label>Company</label>
                    <select name="company_id">
                      <option value="">Unassigned</option>
                      {% for company in companies %}
                        <option value="{{ company.id }}" {% if user.company_id == company.id %}selected{% endif %}>{{ company.name }}{% if not company.is_active %} (inactive){% endif %}</option>
                      {% endfor %}
                    </select>
                    <input name="company" type="text" placeholder="New company name">
                  </div>
                  <div>
                    <label>Company number</label>
                    <input name="company_number" type="text" value="{{ user.company_number }}">
                  </div>
                  <div>
                    <label>Phone</label>
                    <input name="phone" type="text" value="{{ user.phone }}">
                  </div>
                  <div>
                    <label>License tier</label>
                    <select name="license_tier">
                      {% for key, meta in license_tiers.items() %}
                        <option value="{{ key }}" {% if user.license_tier == key %}selected{% endif %}>{{ meta['label'] }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="checkbox">
                    <input type="checkbox" id="admin_{{ user.id }}" name="is_admin" {% if user.is_admin %}checked{% endif %}>
                    <label for="admin_{{ user.id }}" style="margin-bottom:0;">Administrator</label>
                  </div>
                  <div class="checkbox">
                    <input type="hidden" name="require_password_change" value="off">
                    <input type="checkbox" id="pwreset_{{ user.id }}" name="require_password_change" value="on" {% if user.require_password_change %}checked{% endif %}>
                    <label for="pwreset_{{ user.id }}" style="margin-bottom:0;">Require password change</label>
                  </div>
                  <button class="btn" type="submit">Save changes</button>
                </form>
              </td>
            </tr>
            {% if not loop.last %}
            <tr><td colspan="9"><div class="row-divider"></div></td></tr>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
        {% else %}
          <p class="table-note">No user accounts found for this filter.</p>
        {% endif %}
      </div>
    </section>
  </main>

  <script>
    document.querySelectorAll('[data-collapsible]').forEach((section) => {
      const header = section.querySelector('.collapsible-header');
      const toggle = section.querySelector('.collapsible-toggle');
      const content = section.querySelector('.collapsible-content');
      if (!toggle || !content) { return; }
      const setState = (collapsed) => {
        content.style.display = collapsed ? 'none' : '';
        section.classList.toggle('collapsed', collapsed);
        toggle.textContent = collapsed ? 'Show' : 'Hide';
        toggle.setAttribute('aria-expanded', (!collapsed).toString());
      };
      setState(false);
      const handle = (event) => {
        event.preventDefault();
        const collapsed = content.style.display !== 'none' ? true : false;
        setState(collapsed);
      };
      header.addEventListener('click', (event) => {
        if (event.target !== toggle) {
          handle(event);
        }
      });
      toggle.addEventListener('click', handle);
    });
  </script>
</body>
</html>
