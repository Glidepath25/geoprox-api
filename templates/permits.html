<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Permit Records - GeoProx</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      color-scheme: dark;
      --bg: #0b1724;
      --panel: #13283d;
      --text: #f0f6ff;
      --muted: #8ea2ba;
      --accent: #2b7cff;
      --error: #ff9e9e;
      --success: #44d19f;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top right, rgba(43,124,255,0.12), transparent 50%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.1rem 2rem;
    }
    .brand { display: flex; align-items: center; gap: .75rem; font-weight: 600; letter-spacing: .04em; text-transform: uppercase; font-size: .9rem; }
    .brand span { padding: .35rem .7rem; border-radius: 999px; background: rgba(43,124,255,0.18); border: 1px solid rgba(43,124,255,0.4); }
    .actions { display: flex; align-items: center; gap: .75rem; }
    .actions form { margin: 0; }
    .nav-btn, .link-btn {
      background: rgba(255,255,255,0.08);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 999px;
      padding: .45rem 1.05rem;
      cursor: pointer;
      font-size: .88rem;
      text-decoration: none;
      transition: background .15s ease, border-color .15s ease, color .15s ease;
      display: inline-flex;
      align-items: center;
      gap: .35rem;
    }
    .nav-btn:hover, .link-btn:hover { background: rgba(43,124,255,0.2); border-color: rgba(43,124,255,0.45); }
    main { width: 100%; max-width: 1040px; margin: 3rem auto 3.5rem; padding: 0 2rem; flex: 1; }
    h1 { margin: 0 0 1rem; font-size: 2rem; font-weight: 600; }
    .subtitle { margin: 0 0 2.25rem; color: var(--muted); font-size: 1rem; }
    .card {
      background: var(--panel);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.06);
      padding: 1.75rem;
      margin-bottom: 1.75rem;
      box-shadow: 0 18px 45px rgba(11,25,45,0.35);
    }
    .card h2 { margin-top: 0; margin-bottom: 1rem; font-size: 1.2rem; font-weight: 600; }
    label { display: block; font-size: .9rem; font-weight: 600; margin-bottom: .4rem; }
    input[type=text], input[type=date], select, textarea {
      width: 100%;
      padding: .65rem .75rem;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(8,20,38,0.75);
      color: var(--text);
      font-size: .95rem;
    }
    textarea { min-height: 120px; resize: vertical; }
    input[type=text]:focus, input[type=date]:focus, select:focus, textarea:focus {
      outline: none;
      border-color: rgba(43,124,255,0.6);
      box-shadow: 0 0 0 2px rgba(43,124,255,0.15);
    }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
    .form-actions { margin-top: 1.2rem; display: flex; align-items: center; gap: 1rem; }
    .primary-btn {
      background: linear-gradient(135deg, rgba(43,124,255,0.85), rgba(19,104,171,0.85));
      border: 0;
      border-radius: 10px;
      padding: .75rem 1.4rem;
      font-size: .95rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      box-shadow: 0 18px 40px rgba(28,79,150,0.45);
      transition: transform .16s ease, box-shadow .16s ease;
    }
    .primary-btn:hover { transform: translateY(-1px); box-shadow: 0 22px 48px rgba(29,84,158,0.55); }
    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      padding: .35rem .75rem;
      border-radius: 999px;
      font-size: .85rem;
      font-weight: 600;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .status-chip.desktop { border-color: rgba(43,124,255,0.4); background: rgba(43,124,255,0.1); }
    .status-chip.site { border-color: rgba(68,209,159,0.4); background: rgba(68,209,159,0.12); }
    .status-chip.unknown { border-color: rgba(255,255,255,0.1); }
    dl { margin: 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.1rem; }
    dt { font-size: .8rem; text-transform: uppercase; letter-spacing: .04em; color: rgba(255,255,255,0.5); }
    dd { margin: .25rem 0 0; font-size: 1.05rem; font-weight: 600; }
    .muted { color: var(--muted); }
    .error { color: var(--error); font-size: .9rem; }
    .success { color: var(--success); font-size: .9rem; }
    .hidden { display: none !important; }
    .artifact-links { display: flex; flex-wrap: wrap; gap: .6rem; margin-top: 1rem; }
    .artifact-links a { text-decoration: none; color: var(--accent); font-size: .9rem; }
    .artifact-links a:hover { text-decoration: underline; }
    @media (max-width: 720px) {
      header { padding: 1rem 1.25rem; flex-direction: column; align-items: flex-start; gap: .75rem; }
      main { padding: 0 1.25rem; margin-top: 2.5rem; }
      .form-row { grid-template-columns: 1fr; }
      .actions { width: 100%; justify-content: space-between; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span>GeoProx</span>
      <div>Permit workspace</div>
    </div>
    <div class="actions">
      <a class="link-btn" href="/dashboard">? Back to dashboard</a>
      <div class="muted">{{ display_name }}</div>
      <form method="post" action="/logout">
        <button class="nav-btn" type="submit">Sign out</button>
      </form>
    </div>
  </header>
  <main>
    <h1>Permit records</h1>
    <p class="subtitle">Retrieve saved desktop assessments and capture site checks against an existing permit reference.</p>

    <section class="card">
      <h2>Find a permit</h2>
      <form id="permitSearch" class="form-row">
        <div>
          <label for="permitRef">Permit reference</label>
          <input id="permitRef" type="text" placeholder="K6001-DAF-ACON-12345" autocomplete="off" required>
        </div>
        <div style="align-self:flex-end;">
          <button class="primary-btn" type="submit">Open record</button>
        </div>
      </form>
      <div id="searchError" class="error hidden" role="alert"></div>
    </section>

    <section id="permitSummary" class="card hidden" aria-live="polite">
      <div style="display:flex; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
        <div>
          <h2 id="summaryPermit"></h2>
          <div class="muted" id="summaryLocation"></div>
        </div>
        <div style="display:flex; gap:.6rem; flex-wrap:wrap; align-items:flex-start;">
          <span class="status-chip desktop" id="desktopStatusChip">Desktop • Pending</span>
          <span class="status-chip site" id="siteStatusChip">Site • Not started</span>
        </div>
      </div>
      <dl style="margin-top:1.6rem;">
        <div>
          <dt>Desktop outcome</dt>
          <dd id="desktopOutcome">-</dd>
        </div>
        <div>
          <dt>Site outcome</dt>
          <dd id="siteOutcome">-</dd>
        </div>
        <div>
          <dt>Last updated</dt>
          <dd id="updatedAt">-</dd>
        </div>
        <div>
          <dt>Search radius</dt>
          <dd id="summaryRadius">-</dd>
        </div>
      </dl>
      <div class="artifact-links" id="artifactLinks"></div>
    </section>

    <section id="siteAssessment" class="card hidden">
      <h2>Site assessment</h2>
      <p class="muted" style="margin-top:-.4rem; margin-bottom:1.2rem;">Capture the on-site verification and outcomes for this permit.</p>
      <form id="siteForm">
        <div class="form-row">
          <div>
            <label for="siteStatus">Site status</label>
            <select id="siteStatus">
              <option value="Not started">Not started</option>
              <option value="Scheduled">Scheduled</option>
              <option value="In progress">In progress</option>
              <option value="Completed">Completed</option>
              <option value="Requires follow-up">Requires follow-up</option>
            </select>
          </div>
          <div>
            <label for="siteOutcomeSelect">Inspection result</label>
            <select id="siteOutcomeSelect">
              <option value="">Not recorded</option>
              <option value="Pass">Pass</option>
              <option value="Fail">Fail</option>
              <option value="No issues">No issues</option>
              <option value="Action required">Action required</option>
            </select>
          </div>
          <div>
            <label for="inspectionDate">Inspection date</label>
            <input id="inspectionDate" type="date">
          </div>
          <div>
            <label for="inspectorName">Inspector</label>
            <input id="inspectorName" type="text" placeholder="Site lead name">
          </div>
          <div>
            <label for="riskLevel">Risk level</label>
            <select id="riskLevel">
              <option value="">Select</option>
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
            </select>
          </div>
        </div>
        <div style="margin-top:1.1rem;">
          <label for="siteNotes">Notes</label>
          <textarea id="siteNotes" placeholder="Record observations, access constraints, or mitigation actions."></textarea>
        </div>
        <div class="form-actions">
          <button class="primary-btn" type="submit">Save site assessment</button>
          <div id="siteMessage" class="muted"></div>
        </div>
      </form>
    </section>
  </main>

  <script>
    (() => {
      const $ = (sel) => document.querySelector(sel);
      const searchForm = $('#permitSearch');
      const permitInput = $('#permitRef');
      const searchError = $('#searchError');
      const summaryCard = $('#permitSummary');
      const summaryPermit = $('#summaryPermit');
      const summaryLocation = $('#summaryLocation');
      const summaryRadius = $('#summaryRadius');
      const updatedAt = $('#updatedAt');
      const desktopChip = $('#desktopStatusChip');
      const siteChip = $('#siteStatusChip');
      const desktopOutcome = $('#desktopOutcome');
      const siteOutcome = $('#siteOutcome');
      const artifactLinks = $('#artifactLinks');
      const siteCard = $('#siteAssessment');
      const siteForm = $('#siteForm');
      const siteStatus = $('#siteStatus');
      const siteOutcomeSelect = $('#siteOutcomeSelect');
      const inspectionDate = $('#inspectionDate');
      const inspectorName = $('#inspectorName');
      const riskLevel = $('#riskLevel');
      const siteNotes = $('#siteNotes');
      const siteMessage = $('#siteMessage');

      let currentPermitRef = null;
      let currentPermitData = null;

      const clearMessage = () => {
        siteMessage.textContent = '';
        siteMessage.classList.remove('error', 'success');
      };

      const setMessage = (msg, type = 'muted') => {
        siteMessage.textContent = msg || '';
        siteMessage.classList.remove('error', 'success');
        if (!msg) {
          siteMessage.classList.add('muted');
          return;
        }
        if (type === 'error') {
          siteMessage.classList.add('error');
        } else if (type === 'success') {
          siteMessage.classList.add('success');
        } else {
          siteMessage.classList.add('muted');
        }
      };

      const formatDate = (iso) => {
        if (!iso) return '-';
        const date = new Date(iso);
        if (Number.isNaN(date.getTime())) return iso;
        return date.toLocaleString();
      };

      const renderArtifacts = (result) => {
        artifactLinks.innerHTML = '';
        if (!result || typeof result !== 'object') return;
        const artifacts = result.artifacts || {};
        const entries = [];
        const pdf = artifacts.pdf_url || artifacts.pdf_download_url || artifacts.pdf_path;
        const map = artifacts.map_url || artifacts.map_embed_url || artifacts.map_html_url;
        if (pdf) entries.push({ href: pdf, text: 'Download PDF pack' });
        if (map) entries.push({ href: map, text: 'Open interactive map' });
        entries.forEach(({ href, text }) => {
          const link = document.createElement('a');
          link.href = href;
          link.textContent = text;
          link.target = '_blank';
          link.rel = 'noopener';
          artifactLinks.appendChild(link);
        });
      };

      const updateChip = (chip, label, status) => {
        if (!chip) return;
        const value = status || 'Not recorded';
        chip.textContent = `${label} • ${value}`;
        if (chip === siteChip) {
          chip.classList.toggle('unknown', !status);
        }
      };

      const populateSiteForm = (site) => {
        siteStatus.value = site?.status || 'Not started';
        siteOutcomeSelect.value = site?.outcome || '';
        inspectionDate.value = site?.payload?.inspection_date || '';
        inspectorName.value = site?.payload?.inspector || '';
        riskLevel.value = site?.payload?.risk_level || '';
        siteNotes.value = site?.notes || '';
      };

      const renderPermit = (permit) => {
        if (!permit) return;
        currentPermitData = permit;
        currentPermitRef = permit.permit_ref;
        summaryCard.classList.remove('hidden');
        siteCard.classList.remove('hidden');

        summaryPermit.textContent = permit.permit_ref;
        const location = permit.location || {};
        const display = location.display || '-';
        const coords = [];
        if (Number.isFinite(location.lat) && Number.isFinite(location.lon)) {
          coords.push(`${location.lat.toFixed(5)}, ${location.lon.toFixed(5)}`);
        }
        summaryLocation.textContent = coords.length ? `${display} - ${coords.join(' / ')}` : display;
        summaryRadius.textContent = location.radius_m ? `${location.radius_m} m` : '-';
        updatedAt.textContent = formatDate(permit.updated_at);

        const desktop = permit.desktop || {};
        const site = permit.site || {};
        desktopOutcome.textContent = desktop.outcome || '-';
        siteOutcome.textContent = site.outcome || '-';

        updateChip(desktopChip, 'Desktop', desktop.status);
        updateChip(siteChip, 'Site', site.status);

        renderArtifacts(permit.search_result);
        populateSiteForm(site);
        clearMessage();
      };

      const showSearchError = (msg) => {
        if (!msg) {
          searchError.classList.add('hidden');
          searchError.textContent = '';
          return;
        }
        searchError.textContent = msg;
        searchError.classList.remove('hidden');
      };

      const loadPermit = async (ref) => {
        const permitRef = (ref || '').trim();
        if (!permitRef) {
          showSearchError('Enter a permit reference to continue.');
          return;
        }
        showSearchError('');
        setMessage('');
        try {
          const res = await fetch(`/api/permits/${encodeURIComponent(permitRef)}`, {
            credentials: 'include',
          });
          if (res.status === 401) {
            window.location.href = '/';
            return;
          }
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            showSearchError(data?.detail || data?.error || 'Permit record not found.');
            summaryCard.classList.add('hidden');
            siteCard.classList.add('hidden');
            return;
          }
          renderPermit(data);
        } catch (err) {
          console.error('Failed to load permit', err);
          showSearchError('Unable to load that permit right now.');
        }
      };

      const submitSiteAssessment = async (event) => {
        event.preventDefault();
        if (!currentPermitRef) {
          setMessage('Open a permit before saving an assessment.', 'error');
          return;
        }
        clearMessage();
        const payload = {
          status: siteStatus.value || 'Not started',
          outcome: siteOutcomeSelect.value || null,
          notes: siteNotes.value.trim() || null,
          payload: {
            inspection_date: inspectionDate.value || null,
            inspector: inspectorName.value.trim() || null,
            risk_level: riskLevel.value || null,
          },
        };
        try {
          const res = await fetch(`/api/permits/${encodeURIComponent(currentPermitRef)}/site-assessment`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload),
          });
          if (res.status === 401) {
            window.location.href = '/';
            return;
          }
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            setMessage(data?.detail || data?.error || 'Could not save site assessment.', 'error');
            return;
          }
          renderPermit(data);
          setMessage('Site assessment saved.', 'success');
        } catch (err) {
          console.error('Failed to update site assessment', err);
          setMessage('Unexpected error while saving.', 'error');
        }
      };

      searchForm.addEventListener('submit', (event) => {
        event.preventDefault();
        loadPermit(permitInput.value);
      });

      siteForm.addEventListener('submit', submitSiteAssessment);

      permitInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          loadPermit(permitInput.value);
        }
      });
    })();
  </script>
</body>
</html>