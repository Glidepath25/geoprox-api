<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Permit Records - GeoProx</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      color-scheme: dark;
      --bg: #0b1724;
      --panel: #14283d;
      --panel-alt: #102033;
      --text: #f2f7ff;
      --muted: #8ea2ba;
      --accent: #2b7cff;
      --accent-soft: rgba(43, 124, 255, 0.12);
      --border: rgba(255, 255, 255, 0.08);
      --success: #44d19f;
      --error: #ff9e9e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(160deg, rgba(43,124,255,0.08), transparent 50%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 2rem;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 0.85rem;
    }
    .brand span {
      display: inline-flex;
      align-items: center;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      background: var(--accent-soft);
      border: 1px solid rgba(43,124,255,0.45);
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
    }
    .nav-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      padding: 0.45rem 1rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      text-decoration: none;
      font-size: 0.86rem;
      transition: background 0.15s ease, border-color 0.15s ease;
    }
    .nav-btn:hover {
      background: rgba(43,124,255,0.2);
      border-color: rgba(43,124,255,0.45);
    }
    main {
      width: 100%;
      max-width: 1100px;
      margin: 2.5rem auto 3rem;
      padding: 0 2rem 3rem;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1.75rem;
    }
    h1 {
      margin: 0 0 0.4rem;
      font-size: 2rem;
      font-weight: 600;
    }
    .subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 1rem;
    }
    .card {
      background: var(--panel);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 1.75rem;
      box-shadow: 0 20px 50px rgba(10, 22, 40, 0.35);
    }
    .card h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.25rem;
      font-weight: 600;
    }
    .search-form {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.9rem;
      align-items: end;
    }
    label {
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.76);
    }
    input[type="text"] {
      width: 100%;
      padding: 0.7rem 0.85rem;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.15);
      background: var(--panel-alt);
      color: var(--text);
      font-size: 0.95rem;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: rgba(43,124,255,0.65);
      box-shadow: 0 0 0 2px rgba(43,124,255,0.18);
    }
    .primary-btn {
      padding: 0.75rem 1.4rem;
      border-radius: 12px;
      border: 0;
      background: linear-gradient(135deg, rgba(43,124,255,0.9), rgba(24,96,168,0.9));
      color: var(--text);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      box-shadow: 0 18px 40px rgba(30,84,158,0.45);
      transition: transform 0.16s ease, box-shadow 0.16s ease;
    }
    .primary-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 22px 46px rgba(30,84,158,0.55);
    }
    .hint {
      margin-top: 0.7rem;
      color: var(--muted);
      font-size: 0.85rem;
    }
    .flash-list {
      display: grid;
      gap: 0.6rem;
    }
    .flash {
      padding: 0.75rem 1rem;
      border-radius: 12px;
      font-size: 0.9rem;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
    }
    .flash-success { border-color: rgba(68,209,159,0.35); background: rgba(68,209,159,0.18); color: #a7f2d4; }
    .flash-error { border-color: rgba(255,158,158,0.35); background: rgba(255,158,158,0.18); color: #ffb3b3; }
    .results-list {
      display: grid;
      gap: 1rem;
    }
    .result-item {
      padding: 1.2rem 1.4rem;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(9,20,36,0.8);
      display: grid;
      gap: 0.65rem;
    }
    .result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.6rem;
      flex-wrap: wrap;
    }
    .result-header strong {
      font-size: 1.05rem;
      letter-spacing: 0.01em;
    }
    .result-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .status-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      font-size: 0.75rem;
      letter-spacing: 0.03em;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.08);
    }
    .status-pill.status-done { border-color: rgba(68,209,159,0.4); background: rgba(68,209,159,0.15); color: #a7f2d4; }
    .status-pill.status-progress { border-color: rgba(255,200,87,0.4); background: rgba(255,200,87,0.15); color: #ffe5a0; }
    .status-pill.status-pending { border-color: rgba(255,158,158,0.35); background: rgba(255,158,158,0.15); color: #ffb3b3; }
    .meta {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.65);
    }
    .empty-state {
      text-align: center;
      padding: 1.4rem;
      color: var(--muted);
      font-size: 0.9rem;
    }
    .hidden { display: none !important; }
    @media (max-width: 720px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.9rem;
        padding: 1.1rem 1.5rem;
      }
      main {
        padding: 0 1.4rem 2.5rem;
        margin-top: 2.5rem;
      }
      .search-form {
        grid-template-columns: 1fr;
      }
      .result-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .result-actions {
        width: 100%;
      }
      .result-actions .nav-btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span>GeoProx</span>
      <div>Permit workspace</div>
    </div>
    <div class="actions">
      <a class="nav-btn" href="/dashboard">Dashboard</a>
      <a class="nav-btn" href="/app">Desktop check</a>
      <a class="nav-btn" href="/permits">Permits</a>
    </div>
  </header>
  <main>
    <section>
      <h1>Permit records</h1>
      <p class="subtitle">Search for previously saved desktop proximity checks and open them for follow-up site work.</p>
    </section>

    {% if flashes %}
    <div class="flash-list">
      {% for flash in flashes %}
      <div class="flash flash-{{ flash.category }}">{{ flash.message }}</div>
      {% endfor %}
    </div>
    {% endif %}

    <section class="card">
      <h2>Find a permit</h2>
      <form id="permitSearchForm" class="search-form" autocomplete="off">
        <div>
          <label for="permitQuery">Permit reference</label>
          <input id="permitQuery" name="permitQuery" type="text" placeholder="Type a permit reference e.g. TEST-123">
        </div>
        <div>
          <button class="primary-btn" type="submit">Search</button>
        </div>
      </form>
      <p class="hint">Enter part of a reference to see matching permits. Leave blank and search to show your most recent records.</p>
    </section>

    <section class="card">
      <h2>Matching permits</h2>
      <div id="permitResults" class="results-list" data-initial='{{ (initial_results or []) | tojson }}'></div>
      <div id="resultsEmpty" class="empty-state hidden">No permits found. Try another search phrase or create a permit from the desktop module.</div>
    </section>
  </main>

  <script>
    (function () {
      const resultsContainer = document.getElementById('permitResults');
      const emptyState = document.getElementById('resultsEmpty');
      const searchForm = document.getElementById('permitSearchForm');
      const queryInput = document.getElementById('permitQuery');
      let isLoading = false;

      const parseInitial = () => {
        try {
          return JSON.parse(resultsContainer.dataset.initial || '[]');
        } catch (err) {
          console.warn('Failed to parse initial permit results', err);
          return [];
        }
      };

      const statusClass = (status) => {
        if (!status) return 'status-pill';
        const key = String(status).toLowerCase();
        if (key.includes('complete')) return 'status-pill status-done';
        if (key.includes('progress') || key.includes('follow')) return 'status-pill status-progress';
        if (key.includes('pending') || key.includes('start')) return 'status-pill status-pending';
        return 'status-pill';
      };

      const formatDateTime = (value) => {
        if (!value) return '';
        const date = new Date(value);
        if (!Number.isNaN(date.getTime())) {
          return date.toLocaleString();
        }
        return String(value);
      };

      const formatDate = (value) => {
        if (!value) return '';
        const date = new Date(value);
        if (!Number.isNaN(date.getTime())) {
          return date.toLocaleDateString();
        }
        return String(value);
      };

      const renderResults = (items) => {
        resultsContainer.innerHTML = '';
        if (!Array.isArray(items) || items.length === 0) {
          emptyState.classList.remove('hidden');
          return;
        }
        emptyState.classList.add('hidden');
        items.forEach((item) => {
          const wrapper = document.createElement('article');
          wrapper.className = 'result-item';

          const header = document.createElement('div');
          header.className = 'result-header';
          const title = document.createElement('strong');
          title.textContent = item.permit_ref || 'Unknown permit';
          header.appendChild(title);

          const actions = document.createElement('div');
          actions.className = 'result-actions';
          const viewBtn = document.createElement('a');
          viewBtn.className = 'nav-btn';
          viewBtn.href = `/permits/${encodeURIComponent(item.permit_ref || '')}/view`;
          viewBtn.textContent = 'View details';
          actions.appendChild(viewBtn);
          header.appendChild(actions);
          wrapper.appendChild(header);

          const statuses = document.createElement('div');
          statuses.className = 'status-row';
          const desktop = document.createElement('span');
          desktop.className = statusClass(item.desktop_status);
          desktop.textContent = `Desktop: ${item.desktop_status || 'Pending'}`;
          statuses.appendChild(desktop);
          const site = document.createElement('span');
          site.className = statusClass(item.site_status);
          site.textContent = `Site: ${item.site_status || 'Not started'}`;
          statuses.appendChild(site);
          wrapper.appendChild(statuses);

          if (item.desktop_outcome || item.site_outcome) {
            const outcomes = document.createElement('div');
            outcomes.className = 'meta';
            const parts = [];
            if (item.desktop_outcome) parts.push(`Desktop outcome: ${item.desktop_outcome}`);
            if (item.site_outcome) parts.push(`Site results: ${item.site_outcome}`);
            outcomes.textContent = parts.join(' | ');
            wrapper.appendChild(outcomes);
          }

          if (item.updated_at || item.created_at) {
            const meta = document.createElement('div');
            meta.className = 'meta';
            const pieces = [];
            if (item.updated_at) pieces.push(`Updated ${formatDateTime(item.updated_at)}`);
            if (item.created_at) pieces.push(`Created ${formatDate(item.created_at)}`);
            meta.textContent = pieces.join(' | ');
            wrapper.appendChild(meta);
          }

          resultsContainer.appendChild(wrapper);
        });
      };

      const fetchResults = async (query) => {
        if (isLoading) return;
        isLoading = true;
        try {
          const url = new URL('/api/permits/search', window.location.origin);
          if (query) {
            url.searchParams.set('query', query);
          }
          const response = await fetch(url.toString(), { credentials: 'include' });
          if (response.status === 401) {
            window.location.href = '/';
            return;
          }
          const data = await response.json().catch(() => []);
          renderResults(Array.isArray(data) ? data : []);
        } catch (err) {
          console.error('Permit search failed', err);
          renderResults([]);
        } finally {
          isLoading = false;
        }
      };

      searchForm.addEventListener('submit', (event) => {
        event.preventDefault();
        fetchResults(queryInput.value.trim());
      });

      renderResults(parseInitial());
    })();
  </script>
</body>
</html>
