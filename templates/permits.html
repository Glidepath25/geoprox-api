<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Permit Records - GeoProx</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/css/geoprox-theme.css">
  <style>
    .permit-search-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      align-items: end;
    }
    .permit-search-grid button {
      min-width: 160px;
    }
    .permit-table-wrapper {
      overflow-x: auto;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .permit-results-table {
      width: 100%;
      min-width: 960px;
      border-collapse: collapse;
    }
    .permit-results-table th,
    .permit-results-table td {
      padding: 0.65rem 0.8rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      text-align: left;
      vertical-align: top;
    }
    .permit-results-table thead th {
      background: rgba(18, 20, 24, 0.9);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.72rem;
      color: var(--muted);
    }
    .filter-row th {
      background: rgba(0, 0, 0, 0.18);
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .filter-anchor {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
      min-height: 32px;
    }
    .filter-chip {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      font-size: 0.72rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      cursor: pointer;
    }
    .filter-chip:hover,
    .filter-chip.active {
      background: rgba(43, 124, 255, 0.2);
      border-color: rgba(43, 124, 255, 0.45);
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
    }
    .status-pill.status-done {
      border-color: rgba(76, 175, 125, 0.35);
      background: rgba(76, 175, 125, 0.2);
      color: var(--success-green);
    }
    .status-pill.status-progress {
      border-color: rgba(243, 167, 18, 0.35);
      background: rgba(243, 167, 18, 0.2);
      color: var(--warning-amber);
    }
    .status-pill.status-pending {
      border-color: rgba(227, 91, 10, 0.35);
      background: rgba(227, 91, 10, 0.2);
      color: var(--danger-red);
    }
    .permit-empty {
      margin-top: 1.5rem;
      text-align: center;
      color: var(--muted);
    }
    .hidden {
      display: none !important;
    }
    @media (max-width: 720px) {
      .permit-search-grid {
        grid-template-columns: 1fr;
      }
      .permit-search-grid button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="gp-app">
    <header class="gp-header">
      <div class="gp-header-title">
        <img src="/static/geoprox-logo.png" alt="GeoProx logo" style="height:32px">
        <span>Permit workspace</span>
      </div>
      <nav class="gp-nav">
        <a class="gp-btn gp-btn-outline" href="/dashboard">Dashboard</a>
        <a class="gp-btn gp-btn-outline" href="/app">Desktop map</a>
      </nav>
    </header>

    <main class="gp-main">
      <section class="gp-section">
        <h1>Permit records</h1>
        <div class="gp-muted">Search for saved desktop proximity checks and complete the remaining permit stages.</div>
      </section>

      {% if flashes %}
      <section class="gp-section">
        {% for flash in flashes %}
          <div class="gp-flash {{ flash.category }}">{{ flash.message }}</div>
        {% endfor %}
      </section>
      {% endif %}

      <section class="gp-section">
        <h2>Find a permit</h2>
        <form id="permitSearchForm" class="permit-search-grid" autocomplete="off">
          <div class="gp-form-group">
            <label for="permitQuery">Permit reference</label>
            <input id="permitQuery" name="permitQuery" type="text" placeholder="Type a permit reference e.g. TEST-123">
          </div>
          <button class="gp-btn" type="submit">Search</button>
        </form>
        <div class="gp-note" style="margin-top:0.75rem;">
          Enter part of a reference to see matching permits. Leave blank and search to show your most recent records.
        </div>
      </section>

      <section class="gp-section">
        <div class="gp-toolbar">
          <h2>Matching permits</h2>
          <div class="gp-toolbar-group">
            <button id="downloadBtn" type="button" class="gp-btn gp-btn-outline hidden">Download data</button>
          </div>
        </div>
        {% if not allow_desktop %}
        <div class="gp-note">Desktop searches must be completed by a desktop user. You can review existing permits from your company.</div>
        {% endif %}
        {% if has_company_scope %}
        <div class="gp-note" style="margin-top:0.4rem;">Showing permits created by {{ visible_usernames | join(', ') }}.</div>
        {% endif %}

        <div id="resultsWrapper" class="permit-table-wrapper hidden" style="margin-top:1.2rem;">
          <table class="permit-results-table">
            <thead>
              <tr>
                <th scope="col">Permit</th>
                <th scope="col">Created By</th>
                <th scope="col">Desktop Status</th>
                <th scope="col">Desktop Outcome</th>
                <th scope="col">Field Status</th>
                <th scope="col">Bituminous Outcome</th>
                <th scope="col">Sub-base Outcome</th>
                <th scope="col">Sample Status</th>
                <th scope="col">Sample Outcome</th>
                <th scope="col">Sample Date</th>
                <th scope="col">Desktop Date</th>
                <th scope="col">Site Date</th>
              </tr>
              <tr class="filter-row">
                <th><div class="filter-anchor" data-field="permit_ref"></div></th>
                <th><div class="filter-anchor" data-field="owner_username"></div></th>
                <th><div class="filter-anchor" data-field="desktop_status"></div></th>
                <th><div class="filter-anchor" data-field="desktop_outcome"></div></th>
                <th><div class="filter-anchor" data-field="site_status"></div></th>
                <th><div class="filter-anchor" data-field="site_bituminous"></div></th>
                <th><div class="filter-anchor" data-field="site_sub_base"></div></th>
                <th><div class="filter-anchor" data-field="sample_status"></div></th>
                <th><div class="filter-anchor" data-field="sample_outcome"></div></th>
                <th><div class="filter-anchor" data-field="sample_date"></div></th>
                <th><div class="filter-anchor" data-field="desktop_date"></div></th>
                <th><div class="filter-anchor" data-field="site_date"></div></th>
              </tr>
            </thead>
            <tbody id="permitResults" data-initial='{{ (initial_results or []) | tojson }}'></tbody>
          </table>
        </div>
        <div id="resultsEmpty" class="permit-empty hidden">
          No permits found. Try another search phrase or create a permit from the desktop module.
        </div>
      </section>
    </main>

    <footer class="gp-footer">
      Permit data syncs with your desktop proximity checks and site assessments.
    </footer>
  </div>

  <script>
    (function () {
      const resultsWrapper = document.getElementById('resultsWrapper');
      const resultsContainer = document.getElementById('permitResults');
      const emptyState = document.getElementById('resultsEmpty');
      const searchForm = document.getElementById('permitSearchForm');
      const queryInput = document.getElementById('permitQuery');
      const downloadBtn = document.getElementById('downloadBtn');
      const filterAnchors = Array.from(document.querySelectorAll('.filter-anchor'));
      const filterAnchorMap = filterAnchors.reduce((acc, anchor) => {
        acc[anchor.dataset.field] = anchor;
        return acc;
      }, {});

      const renderDate = (primary, fallback) => {
        const source = primary || fallback;
        if (!source) return '';
        if (typeof source === 'string' && source.includes('/') && source.length <= 10) {
          return source;
        }
        const date = new Date(source);
        if (Number.isNaN(date.getTime())) return String(source);
        const pad = (num) => String(num).padStart(2, '0');
        return `${pad(date.getUTCDate())}/${pad(date.getUTCMonth() + 1)}/${String(date.getUTCFullYear()).slice(-2)}`;
      };

      const valueOrDash = (value) => {
        if (!value && value !== 0) return '—';
        return typeof value === 'string' ? value : String(value);
      };

      const buildStatusCell = (status, fallback) => {
        const pill = document.createElement('span');
        pill.className = 'status-pill';
        const text = (status || fallback || '').toString();
        pill.textContent = text || '—';
        const lower = text.toLowerCase();
        if (lower.includes('complete') || lower.includes('done')) {
          pill.classList.add('status-done');
        } else if (lower.includes('pending') || lower.includes('progress')) {
          pill.classList.add('status-progress');
        } else if (!text || text === '—') {
          pill.classList.add('status-pending');
        }
        const cell = document.createElement('td');
        cell.appendChild(pill);
        return cell;
      };

      const filterConfig = [
        { field: 'permit_ref', label: 'Permit' },
        { field: 'owner_username', label: 'Owner' },
        { field: 'desktop_status', label: 'Desktop status' },
        { field: 'desktop_outcome', label: 'Desktop outcome' },
        { field: 'site_status', label: 'Field status' },
        { field: 'site_bituminous', label: 'Bituminous outcome' },
        { field: 'site_sub_base', label: 'Sub-base outcome' },
        { field: 'sample_status', label: 'Sample status' },
        { field: 'sample_outcome', label: 'Sample outcome' },
        { field: 'sample_date', label: 'Sample date' },
        { field: 'desktop_date', label: 'Desktop date' },
        { field: 'site_date', label: 'Site date' },
      ];

      let lastQuery = '';
      let allItems = [];
      let filterOptions = {};
      let filterState = {};
      let isLoading = false;

      const buildFilterOptions = (items) => {
        const map = {};
        filterConfig.forEach(({ field }) => { map[field] = new Map(); });
        items.forEach((item) => {
          filterConfig.forEach(({ field }) => {
            const raw = item[field];
            if (raw === undefined || raw === null || raw === '') return;
            const value = String(raw);
            const store = map[field];
            store.set(value, (store.get(value) || 0) + 1);
          });
        });
        const result = {};
        Object.entries(map).forEach(([field, store]) => {
          result[field] = Array.from(store.entries()).sort((a, b) => a[0].localeCompare(b[0], undefined, { sensitivity: 'base' }));
        });
        return result;
      };

      const renderFilterControls = () => {
        Object.values(filterAnchorMap).forEach((anchor) => { anchor.innerHTML = ''; });
        filterConfig.forEach(({ field }) => {
          const anchor = filterAnchorMap[field];
          if (!anchor) return;
          const chips = filterOptions[field] || [];
          chips.forEach(([value, count]) => {
            const chip = document.createElement('button');
            chip.type = 'button';
            chip.className = 'filter-chip';
            chip.dataset.field = field;
            chip.dataset.value = value;
            chip.textContent = `${value} (${count})`;
            if (filterState[field] && filterState[field].has(value)) {
              chip.classList.add('active');
            }
            chip.addEventListener('click', () => {
              const state = filterState[field] || new Set();
              if (state.has(value)) {
                state.delete(value);
                if (state.size === 0) delete filterState[field];
              } else {
                state.add(value);
                filterState[field] = state;
              }
              renderFilterControls();
              refreshTable();
            });
            anchor.appendChild(chip);
          });
        });
      };

      const applyFilters = (items) => {
        const entries = Object.entries(filterState);
        if (!entries.length) return items;
        return items.filter((item) => {
          return entries.every(([field, selected]) => {
            if (!selected || selected.size === 0) return true;
            const value = item[field];
            if (value === undefined || value === null) return false;
            return selected.has(String(value));
          });
        });
      };

      const renderTable = (items) => {
        resultsContainer.innerHTML = '';
        if (!items.length) {
          resultsWrapper.classList.add('hidden');
          emptyState.classList.remove('hidden');
          updateDownloadState(false);
          return;
        }
        emptyState.classList.add('hidden');
        resultsWrapper.classList.remove('hidden');
        updateDownloadState(true);
        items.forEach((item) => {
          const row = document.createElement('tr');
          const permitCell = document.createElement('td');
          const permitLink = document.createElement('a');
          permitLink.href = `/permits/${encodeURIComponent(item.permit_ref)}/view`;
          permitLink.className = 'gp-link';
          permitLink.textContent = item.permit_ref || '—';
          permitCell.appendChild(permitLink);
          row.appendChild(permitCell);

          const ownerCell = document.createElement('td');
          ownerCell.textContent = valueOrDash(item.owner_username);
          row.appendChild(ownerCell);

          row.appendChild(buildStatusCell(item.desktop_status, 'Pending'));

          const desktopOutcomeCell = document.createElement('td');
          desktopOutcomeCell.textContent = valueOrDash(item.desktop_outcome);
          row.appendChild(desktopOutcomeCell);

          row.appendChild(buildStatusCell(item.site_status, 'Pending'));

          const bituminousCell = document.createElement('td');
          bituminousCell.textContent = valueOrDash(item.site_bituminous || item.bituminous_outcome);
          row.appendChild(bituminousCell);

          const subBaseCell = document.createElement('td');
          subBaseCell.textContent = valueOrDash(item.site_sub_base || item.sub_base_outcome);
          row.appendChild(subBaseCell);

          row.appendChild(buildStatusCell(item.sample_status, 'Not required'));

          const sampleOutcomeCell = document.createElement('td');
          sampleOutcomeCell.textContent = valueOrDash(item.sample_outcome);
          row.appendChild(sampleOutcomeCell);

          const sampleDateCell = document.createElement('td');
          sampleDateCell.textContent = renderDate(item.sample_date, item.updated_at) || '—';
          row.appendChild(sampleDateCell);

          const desktopDateCell = document.createElement('td');
          desktopDateCell.textContent = renderDate(item.desktop_date, item.created_at) || '—';
          row.appendChild(desktopDateCell);

          const siteDateCell = document.createElement('td');
          siteDateCell.textContent = renderDate(item.site_date, item.updated_at) || '—';
          row.appendChild(siteDateCell);

          resultsContainer.appendChild(row);
        });
      };

      const updateDownloadState = (hasRows) => {
        if (!downloadBtn) return;
        if (hasRows) {
          downloadBtn.classList.remove('hidden');
          downloadBtn.disabled = false;
        } else {
          downloadBtn.classList.add('hidden');
          downloadBtn.disabled = true;
        }
      };

      const refreshTable = () => {
        const filtered = applyFilters(allItems);
        renderTable(filtered);
      };

      const updateFiltersFromItems = (items) => {
        filterOptions = buildFilterOptions(items);
        filterConfig.forEach(({ field }) => {
          if (filterState[field] === undefined) return;
          const existing = filterState[field];
          if (!existing || existing.size === 0) {
            delete filterState[field];
            return;
          }
          const validKeys = new Set((filterOptions[field] || []).map(([key]) => key));
          const retained = Array.from(existing).filter((value) => validKeys.has(value));
          if (retained.length === 0 || retained.length === validKeys.size) {
            delete filterState[field];
          } else {
            filterState[field] = new Set(retained);
          }
        });
        renderFilterControls();
      };

      const parseInitial = () => {
        try {
          const attr = resultsContainer?.dataset?.initial;
          if (!attr) return [];
          const parsed = JSON.parse(attr);
          return Array.isArray(parsed) ? parsed : [];
        } catch (err) {
          console.warn('Failed to parse initial permits', err);
          return [];
        }
      };

      const fetchResults = async (query) => {
        if (isLoading) return;
        isLoading = true;
        try {
          const url = new URL('/api/permits/search', window.location.origin);
          if (query) {
            url.searchParams.set('query', query);
          }
          const response = await fetch(url.toString(), { credentials: 'include' });
          if (response.status === 401) {
            window.location.href = '/';
            return;
          }
          const data = await response.json().catch(() => []);
          allItems = Array.isArray(data) ? data : [];
          filterState = {};
          updateFiltersFromItems(allItems);
          refreshTable();
        } catch (err) {
          console.error('Permit search failed', err);
          allItems = [];
          filterState = {};
          updateFiltersFromItems(allItems);
          refreshTable();
        } finally {
          isLoading = false;
        }
      };

      if (downloadBtn) {
        downloadBtn.addEventListener('click', () => {
          if (downloadBtn.disabled) return;
          const url = new URL('/api/permits/export', window.location.origin);
          if (lastQuery) {
            url.searchParams.set('query', lastQuery);
          }
          url.searchParams.set('limit', '1000');
          Object.entries(filterState).forEach(([field, values]) => {
            if (!values || values.size === 0) return;
            values.forEach((value) => {
              url.searchParams.append(`filter_${field}`, value);
            });
          });
          window.location.href = url.toString();
        });
      }

      searchForm.addEventListener('submit', (event) => {
        event.preventDefault();
        lastQuery = queryInput.value.trim();
        fetchResults(lastQuery);
      });

      allItems = parseInitial();
      updateFiltersFromItems(allItems);
      refreshTable();
    })();
  </script>
</body>
</html>
