<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='utf-8'>
  <title>GeoProx</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel='stylesheet' href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css' integrity='sha256-o9N1j7kP5S2s3fV0w5pG1rN1Lt3vJhbC7rGQ2PpHt0A=' crossorigin=''/>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0b1724;
      --panel: #12263a;
      --text: #e6f1ff;
      --muted: #9fb3c7;
      --accent: #2b7cff;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, Arial, sans-serif; background: var(--bg); color: var(--text); }
    header { display: flex; align-items: center; gap: .6rem; padding: 1rem 1.25rem; }
    header img { height: 32px; }
    header h1 { font-size: 1.1rem; margin: 0; font-weight: 600; }
    main { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 1100px) { .grid { grid-template-columns: 1.2fr .8fr; } }
    .card { background: var(--panel); border-radius: 12px; padding: 1rem; }
    .row { display: flex; gap: .75rem; flex-wrap: wrap; }
    label.small { display: block; color: var(--muted); font-size: .82rem; margin: .2rem 0 .35rem; }
    input[type=text], input[type=number] {
      width: 100%;
      padding: .6rem .7rem;
      border-radius: 8px;
      border: 1px solid #1f3952;
      background: #0e2133;
      color: var(--text);
    }
    .btn { padding: .55rem .9rem; border: 0; border-radius: 8px; background: var(--accent); color: #fff; cursor: pointer; }
    .btn.secondary { background: #1a3350; }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }
    .badge { display: inline-block; padding: .25rem .6rem; border-radius: 999px; font-weight: 600; }
    .badge-low { background: #0b4d27; }
    .badge-medium { background: #614a00; }
    .badge-high { background: #6b1111; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: .55rem .6rem; border-bottom: 1px solid #1f3952; text-align: left; }
    .muted { color: var(--muted); }
    iframe { width: 100%; height: 520px; border: 0; background: #06111b; }
    .error { color: #ff9e9e; white-space: pre-wrap; }
    .top-actions { display: flex; justify-content: flex-end; gap: .5rem; margin-bottom: .75rem; }
    .logout-btn { background: #1a3350; color: var(--muted); border: 1px solid rgba(255, 255, 255, 0.08); padding: .45rem .8rem; border-radius: 8px; cursor: pointer; }
    .logout-btn:hover { color: #fff; border-color: rgba(255, 255, 255, 0.18); }
    #pickerMap { height: 280px; border-radius: 12px; margin-top: 0.25rem; }
  </style>
</head>
<body>
  <header>
    <img src='/static/geoprox-logo.png' alt='GeoProx logo'>
    <h1>GeoProx — Proximity Checker</h1>
  </header>

  <main class='grid'>
    <section class='card'>
      <form class='top-actions' method='post' action='/logout'>
        <button class='logout-btn' type='submit'>Sign out</button>
      </form>
      <div class='row'>
        <div style='flex:2'>
          <label class='small'>Location (lat,lon or ///what.three.words)</label>
          <input id='location' type='text' placeholder='54.35,-6.65  or  ///three.words.here'>
        </div>
        <div style='flex:.8'>
          <label class='small'>Radius (metres)</label>
          <input id='radius' type='number' value='2000' min='10' max='20000'>
        </div>
        <div style='flex:1.2'>
          <label class='small'>Permit number (optional)</label>
          <input id='permit' type='text' placeholder='K6001-DAF-ACON-12345'>
        </div>
        <div style='align-self:flex-end'>
          <button id='runBtn' class='btn' type='button'>Run search</button>
        </div>
      </div>

      <div style='margin-top:.6rem'>
        <label class='small'>Categories to search</label>
        <div class='row muted' style='line-height:1.9'>
          <label><input type='checkbox' name='cat' data-cat='industrial' checked> Industrial / Manufacturing</label>
          <label><input type='checkbox' name='cat' data-cat='gas' checked> Gas holder stations</label>
          <label><input type='checkbox' name='cat' data-cat='mining' checked> Mining (coal, metalliferous)</label>
          <label><input type='checkbox' name='cat' data-cat='petrol' checked> Petrol stations / Garages</label>
          <label><input type='checkbox' name='cat' data-cat='subs' checked> Sub-Stations</label>
          <label><input type='checkbox' name='cat' data-cat='landfill' checked> Waste Site — Landfill / Disposal</label>
          <label><input type='checkbox' name='cat' data-cat='scrapyard' checked> Waste Site — Scrapyard / Metal</label>
          <label><input type='checkbox' name='cat' data-cat='other' checked> Waste Site — Other</label>
        </div>
      </div>

      <div style='margin-top:.6rem'>
        <label class='small'>Click map to set search origin</label>
        <div id='pickerMap'></div>
      </div>

      <div class='row' style='margin-top:.6rem; align-items:center'>
        <div id='outcomeBadge' class='badge badge-low'>LOW</div>
        <div class='muted' id='centerLabel'></div>
        <div class='muted'>•</div>
        <div class='muted' id='radiusLabel'></div>
        <div class='muted'>•</div>
        <div class='muted' id='permitLabel'></div>
        <div style='flex:1'></div>
        <a id='downloadBtn' class='btn secondary' href='#' target='_blank' rel='noopener' disabled>Download PDF</a>
        <button id='openMapBtn' class='btn secondary' type='button' disabled>Open Map</button>
      </div>

      <div style='margin-top:.6rem'>
        <table>
          <thead>
            <tr><th>Category</th><th>No</th><th>&lt;10m</th><th>10–25m</th><th>25–100m</th></tr>
          </thead>
          <tbody id='detailsBody'><tr><td class='muted' colspan='5'>Run a search to see results.</td></tr></tbody>
        </table>
      </div>

      <div id='errorTxt' class='error' style='display:none; margin-top:.5rem'></div>
    </section>

    <section class='card'>
      <div class='muted' style='margin-bottom:.4rem'>Map preview</div>
      <iframe id='mapFrame' src='about:blank' title='GeoProx map'></iframe>
    </section>
  </main>

  <script src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js' integrity='sha256-o8UstJf3yJ3bWc6RRL/bM7PqYpX9GL4j1ZNu2wQAE1w=' crossorigin=''></script>
  <script>
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const text = (el, val) => { if (el) el.textContent = val ?? ''; };
    const html = (el, val) => { if (el) el.innerHTML = val ?? ''; };
    const showError = (msg) => {
      const box = $('#errorTxt');
      if (!msg) { box.style.display = 'none'; box.textContent = ''; return; }
      box.textContent = msg;
      box.style.display = 'block';
    };

    const locationEl = $('#location');
    const radiusEl = $('#radius');
    const permitEl = $('#permit');
    const runBtn = $('#runBtn');
    const downloadBtn = $('#downloadBtn');
    const openMapBtn = $('#openMapBtn');
    const outcomeBadge = $('#outcomeBadge');
    const centerLabel = $('#centerLabel');
    const radiusLabel = $('#radiusLabel');
    const permitLabel = $('#permitLabel');
    const detailsBody = $('#detailsBody');
    const mapFrame = $('#mapFrame');

    let pickerMap;
    let pickerMarker;

    const setOutcomeBadge = (level = 'LOW') => {
      const lvl = String(level || 'LOW').toUpperCase();
      outcomeBadge.classList.remove('badge-low', 'badge-medium', 'badge-high');
      outcomeBadge.classList.add(lvl === 'HIGH' ? 'badge-high' : lvl === 'MEDIUM' ? 'badge-medium' : 'badge-low');
      text(outcomeBadge, lvl);
    };

    const selectedCategories = () =>
      $$("input[type='checkbox'][name='cat']").filter((box) => box.checked).map((box) => box.dataset.cat || box.value);

    const renderSummaryTable = (items = []) => {
      if (!Array.isArray(items) || items.length === 0) {
        html(detailsBody, "<tr><td class='muted' colspan='5'>No nearby features found.</td></tr>");
        return;
      }
      const rows = items.map((row) => `
        <tr>
          <td>${row.label ?? '—'}</td>
          <td>${row.no ? '✔︎' : ''}</td>
          <td>${row.lt10 ? '✔︎' : ''}</td>
          <td>${row.r10_25 ? '✔︎' : ''}</td>
          <td>${row.r25_100 ? '✔︎' : ''}</td>
        </tr>
      `).join('');
      html(detailsBody, rows);
    };

    const parseLocation = (value) => {
      if (!value) return null;
      if (value.startsWith('///')) return null;
      const cleaned = value.replace(/\s+/g, '');
      const parts = cleaned.split(',');
      if (parts.length !== 2) return null;
      const lat = parseFloat(parts[0]);
      const lon = parseFloat(parts[1]);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
      return [lat, lon];
    };

    const initialisePickerMap = () => {
      const defaultCenter = [54.5973, -5.9301];
      const parsed = parseLocation(locationEl.value);
      const center = parsed || defaultCenter;

      pickerMap = L.map('pickerMap', { zoomControl: true }).setView(center, 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(pickerMap);

      pickerMarker = L.marker(center, { draggable: false }).addTo(pickerMap);

      pickerMap.on('click', (event) => {
        const { lat, lng } = event.latlng;
        locationEl.value = `${lat.toFixed(6)},${lng.toFixed(6)}`;
        updatePickerMarker([lat, lng]);
      });
    };

    const updatePickerMarker = (coords) => {
      if (!coords || !Array.isArray(coords)) return;
      const lat = coords[0];
      const lon = coords[1];
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
      if (pickerMarker) {
        pickerMarker.setLatLng([lat, lon]);
      }
      if (pickerMap) {
        pickerMap.setView([lat, lon]);
      }
    };

    async function runSearch() {
      try {
        showError('');
        const payload = {
          location: (locationEl.value || '').trim(),
          radius_m: parseInt(radiusEl.value, 10) || 2000,
          categories: selectedCategories(),
          permit: (permitEl.value || '').trim() || null,
          max_results: null,
        };

        const res = await fetch('/api/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload),
        });

        const json = await res.json().catch(() => ({}));

        if (res.status === 401) {
          window.location.href = '/';
          return;
        }

        if (!res.ok) {
          showError(json?.error || `Request failed (${res.status})`);
          console.error('API error', json);
          return;
        }

        if (json.status !== 'done' || !json.result) {
          showError(json?.error || 'Search failed.');
          console.error('Unexpected response', json);
          return;
        }

        const result = json.result || {};
        const summary = result.summary || {};
        const artifacts = result.artifacts || {};

        setOutcomeBadge(summary.outcome || 'LOW');
        text(centerLabel, summary.center || '');
        text(radiusLabel, summary.radius ? `Radius: ${summary.radius} m` : '');
        text(permitLabel, summary.permit ? `Permit: ${summary.permit}` : '');
        renderSummaryTable(summary.categories || []);

        if (summary.center_coords) {
          updatePickerMarker([summary.center_coords.lat, summary.center_coords.lon]);
        }

        const pdfUrl = artifacts.pdf_url || artifacts.pdf_download_url || null;
        if (pdfUrl) {
          downloadBtn.href = pdfUrl;
          downloadBtn.removeAttribute('disabled');
        } else {
          downloadBtn.setAttribute('disabled', 'true');
          downloadBtn.removeAttribute('href');
        }

        const mapUrl = artifacts.map_url || artifacts.map_embed_url || null;
        if (mapUrl) {
          mapFrame.src = mapUrl;
          openMapBtn.removeAttribute('disabled');
          openMapBtn.onclick = () => window.open(mapUrl, '_blank', 'noopener');
        } else {
          mapFrame.src = 'about:blank';
          openMapBtn.setAttribute('disabled', 'true');
          openMapBtn.onclick = null;
        }
      } catch (err) {
        console.error(err);
        showError(err?.message || 'Unexpected error');
      }
    }

    fetch('/auth-status', { credentials: 'include' })
      .then((res) => {
        if (res.status === 401) {
          window.location.href = '/';
        }
      })
      .catch(() => {});

    initialisePickerMap();

    const initialCoords = parseLocation(locationEl.value);
    if (initialCoords) {
      updatePickerMarker(initialCoords);
    }

    runBtn.addEventListener('click', runSearch);
    locationEl.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        runSearch();
      }
    });
  </script>
</body>
</html>
