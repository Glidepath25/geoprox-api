<!DOCTYPE html><html lang="en"><head>  <meta charset="utf-8">  <title>GeoProx</title>  <meta name="viewport" content="width=device-width, initial-scale=1">  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" crossorigin="">  <style>    :root {      color-scheme: dark;      --bg: #0b1724;      --panel: #12263a;      --text: #e6f1ff;      --muted: #9fb3c7;      --accent: #2b7cff;    }    * { box-sizing: border-box; }    body { margin: 0; font-family: system-ui, Arial, sans-serif; background: var(--bg); color: var(--text); }    header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.25rem; }    .brand { display: flex; align-items: center; gap: .6rem; }    header img { height: 32px; }    header h1 { font-size: 1.1rem; margin: 0; font-weight: 600; }    main { max-width: none; width: 100%; margin: 0; padding: 1rem 2.5rem; }    .grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }    @media (min-width: 1100px) { .grid { grid-template-columns: 1.2fr .8fr; } }    .card { background: var(--panel); border-radius: 12px; padding: 1rem; }    .row { display: flex; gap: .75rem; flex-wrap: wrap; }    label.small { display: block; color: var(--muted); font-size: .82rem; margin: .2rem 0 .35rem; }    input[type=text], input[type=number] {      width: 100%;      padding: .6rem .7rem;      border-radius: 8px;      border: 1px solid #1f3952;      background: #0e2133;      color: var(--text);    }    .btn { padding: .55rem .9rem; border: 0; border-radius: 8px; background: var(--accent); color: #fff; cursor: pointer; }    .btn.secondary { background: #1a3350; }    .btn[disabled] { opacity: .6; cursor: not-allowed; }    .badge { display: inline-block; padding: .25rem .6rem; border-radius: 999px; font-weight: 600; }    .badge-low { background: #0b4d27; }    .badge-medium { background: #614a00; }    .badge-high { background: #6b1111; }    table { width: 100%; border-collapse: collapse; }    th, td { padding: .55rem .6rem; border-bottom: 1px solid #1f3952; text-align: left; }    .muted { color: var(--muted); }    iframe { width: 100%; height: 520px; border: 0; background: #06111b; }    .error { color: #ff9e9e; white-space: pre-wrap; }    .top-actions { display: flex; align-items: center; gap: .6rem; }    .nav-btn { background: #1a3350; color: var(--muted); border: 1px solid rgba(255, 255, 255, 0.08); padding: .45rem .9rem; border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; min-width: 96px; font-size: .85rem; }    .nav-btn:hover { color: #fff; border-color: rgba(255, 255, 255, 0.18); }    .top-actions form { margin: 0; }    #pickerMap { height: 340px; border-radius: 12px; margin-top: 0.25rem; width: 100%; background: #0e2133; }    .history-section { margin-top: .75rem; }    .history-title { font-size: 0.85rem; color: var(--muted); margin-bottom: 0.35rem; }    .history-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }    .history-table th, .history-table td { padding: 0.35rem 0.45rem; border-bottom: 1px solid #1f3952; text-align: left; color: var(--text); }    .history-low { color: #2e7d32; font-weight: 600; }    .history-medium { color: #ef6c00; font-weight: 600; }    .history-high { color: #c62828; font-weight: 600; }        .category-list { display: flex; flex-wrap: wrap; gap: .4rem 1rem; font-size: .78rem; }    .category-list label { display: inline-flex; align-items: center; gap: .3rem; }    .category-list input[type=checkbox] { transform: scale(0.9); }    .form-row { display: flex; gap: .75rem; flex-wrap: wrap; }    .permit-input { flex: 1; }    .layout { display: flex; flex-direction: column; gap: 1.2rem; margin-top: 1rem; }    .map-panel { display: flex; flex-direction: column; gap: .85rem; }    .map-preview { display: flex; flex-direction: column; gap: .85rem; }    .map-preview .map-header { display: flex; justify-content: space-between; align-items: center; gap: .5rem; }    .map-controls { display: flex; gap: .5rem; flex-wrap: wrap; }    .map-controls .btn { width: 100%; }    .map-mode { margin-top: .75rem; display: flex; justify-content: space-between; align-items: center; gap: .5rem; }    .map-mode-buttons { display: flex; gap: .5rem; }    .mode-btn { background: #0f1f31; border: 1px solid rgba(255, 255, 255, 0.12); color: var(--muted); padding: .35rem .75rem; border-radius: 999px; font-size: .78rem; cursor: pointer; transition: background .12s ease, border-color .12s ease, color .12s ease; }    .mode-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }    .map-frame { width: 100%; border: 0; border-radius: 12px; background: #06111b; height: 300px; }    .map-preview.expanded { position: fixed; inset: 5vh 8vw; z-index: 1000; padding: 1.5rem; background: var(--panel); border-radius: 12px; box-shadow: 0 24px 60px rgba(0, 0, 0, 0.55); display: flex; flex-direction: column; gap: .85rem; max-height: 90vh; overflow: hidden; }    .map-preview.expanded .map-frame { flex: 1; height: 100%; }    .btn.small { font-size: .78rem; padding: .45rem .7rem; }    body.no-scroll { overflow: hidden; }    #mapOverlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.65); z-index: 900; }    #mapOverlay.visible { display: block; }    .search-card { display: flex; flex-direction: column; gap: .8rem; }    .summary-row { display: flex; align-items: center; gap: .6rem; flex-wrap: wrap; margin-top: .2rem; }    .summary-row .muted { font-size: .85rem; }    .search-card table { font-size: .82rem; }    .search-card table th, .search-card table td { padding: .45rem .4rem; }    .street-card { display: flex; flex-direction: column; gap: .85rem; }    .streetview-header { display: flex; justify-content: space-between; align-items: center; gap: .5rem; }    #streetViewFrame { width: 100%; height: 320px; border: 0; border-radius: 10px; background: #06111b; }    #streetViewHint { margin-top: .25rem; font-size: .8rem; color: var(--muted); }    @media (min-width: 768px) {      .map-controls { flex-wrap: nowrap; }      .map-controls .btn { width: auto; }    }    @media (min-width: 1200px) {      .layout { flex-direction: row; align-items: stretch; }      .map-panel { flex: 0 0 280px; }      .search-card { flex: 1.5; }      .street-card { flex: 1.3; }      .map-frame { height: 360px; }    }    @media (min-width: 1600px) {      .layout { flex-direction: row; align-items: stretch; }      .map-panel { flex: 0 0 320px; }      .search-card { flex: 1.5; }      .street-card { flex: 1.6; }      .map-frame { height: 380px; }    }  </style></head><body>  <header>    <div class="brand">      <img src="/static/geoprox-logo.png" alt="GeoProx logo">      <h1>GeoProx - Proximity Checker</h1>    </div>    <div class="top-actions">      <a class="nav-btn" href="/history">History</a>      <form method="post" action="/logout">        <button class="nav-btn" type="submit">Sign out</button>      </form>    </div>  </header>  <main class="layout">    <section class="card map-panel" id="mapPanel">      <div class="map-preview" id="mapPreview">        <div class="map-header">        <span class="muted">Map preview</span>        <div class="map-controls">          <button id="toggleMapSize" class="btn secondary small" type="button">Enlarge map</button>          <button id="openMapBtn" class="btn secondary small" type="button" disabled>Open Map</button>        </div>      </div>      <iframe id="mapFrame" class="map-frame" src="about:blank" title="GeoProx map"></iframe>      </div>      <div class="history-section">        <div class="history-title">Previous searches</div>        <table class="history-table">          <thead>            <tr><th>When</th><th>Location</th><th>Outcome</th></tr>          </thead>          <tbody id="historyBody"><tr><td class="muted" colspan="3">No history yet.</td></tr></tbody>        </table>      </div>    </section>    <section class="card search-card">            <div class="row">        <div style="flex:2">          <label class="small">Location (lat,lon or ///what.three.words)</label>          <input id="location" type="text" placeholder="54.35,-6.65 or ///three.words.here">        </div>        <div style="flex:.8">          <label class="small">Radius (metres)</label>          <input id="radius" type="number" value="500" min="10" max="20000">        </div>        <div style="align-self:flex-end">          <button id="runBtn" class="btn" type="button">Run search</button>        </div>      </div>      <div class="form-row">        <div class="permit-input">          <label class="small">Permit number (optional)</label>          <input id="permit" type="text" placeholder="K6001-DAF-ACON-12345">        </div>      </div>      <div style="margin-top:.6rem">        <label class="small">Categories to search</label>        <div class="category-list muted">          <label><input type="checkbox" name="cat" data-cat="industrial" checked> Industrial / Manufacturing</label>          <label><input type="checkbox" name="cat" data-cat="gas" checked> Gas holder stations</label>          <label><input type="checkbox" name="cat" data-cat="mining" checked> Mining (coal, metalliferous)</label>          <label><input type="checkbox" name="cat" data-cat="petrol" checked> Petrol stations / Garages</label>          <label><input type="checkbox" name="cat" data-cat="subs" checked> Sub-Stations</label>          <label><input type="checkbox" name="cat" data-cat="landfill" checked> Waste Site - Landfill / Disposal</label>          <label><input type="checkbox" name="cat" data-cat="scrapyard" checked> Waste Site - Scrapyard / Metal</label>          <label><input type="checkbox" name="cat" data-cat="other" checked> Waste Site - Other</label>        </div>      </div>      <div class="summary-row">        <div id="outcomeBadge" class="badge badge-low">LOW</div>        <div class="muted" id="centerLabel"></div>        <div class="muted" id="radiusLabel"></div>        <div class="muted" id="permitLabel"></div>        <div style="flex:1"></div>        <a id="downloadBtn" class="btn secondary" href="#" target="_blank" rel="noopener" disabled>Download PDF</a>        <button id="savePermitBtn" class="btn" type="button" disabled>Save permit record</button>        <span id="savePermitStatus" class="muted"></span>      </div>      <div>        <table>          <thead>            <tr><th>Category</th><th>No</th><th><10m</th><th>10-25m</th><th>25-100m</th></tr>          </thead>          <tbody id="detailsBody"><tr><td class="muted" colspan="5">Run a search to see results.</td></tr></tbody>        </table>      </div>      <div id="errorTxt" class="error" style="display:none; margin-top:.5rem"></div>    </section>    <section class="card street-card">      <div>        <div class="map-mode"><span class="small muted">Selection mode</span><div class="map-mode-buttons"><button type="button" class="mode-btn active" data-mode="point">Point</button><button type="button" class="mode-btn" data-mode="polygon">Polygon</button></div></div>        <label id="mapInstruction" class="small">Click map to set search origin</label>        <div id="pickerMap" class="map-frame"></div>      </div>      <div class="streetview-header">        <span class="muted">Street View preview</span>        <button id="openStreetViewBtn" class="btn secondary small" type="button" disabled>Open Street View</button>      </div>      <iframe id="streetViewFrame" src="about:blank" title="Street View preview"></iframe>      <div id="streetViewHint" class="muted">Street View appears once a search returns a location.</div>    </section>  </main>  <div id="mapOverlay"></div>  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js" crossorigin=""></script>  <script>  (function () {    const $ = (sel) => document.querySelector(sel);    const $$ = (sel) => Array.from(document.querySelectorAll(sel));    const text = (el, val) => { if (el) el.textContent = val ?? ''; };    const html = (el, val) => { if (el) el.innerHTML = val ?? ''; };    const showError = (msg) => {      const box = $('#errorTxt');      if (!msg) { box.style.display = 'none'; box.textContent = ''; return; }      box.textContent = msg;      box.style.display = 'block';    };    const locationEl = $('#location');    const radiusEl = $('#radius');    const permitEl = $('#permit');    const runBtn = $('#runBtn');    const downloadBtn = $('#downloadBtn');    const savePermitBtn = $('#savePermitBtn');    const savePermitStatus = $('#savePermitStatus');    const openMapBtn = $('#openMapBtn');    const outcomeBadge = $('#outcomeBadge');    const centerLabel = $('#centerLabel');    const radiusLabel = $('#radiusLabel');    const permitLabel = $('#permitLabel');    const detailsBody = $('#detailsBody');    const mapFrame = $('#mapFrame');    const mapPanel = $('#mapPanel');    const mapPreview = $('#mapPreview');    const toggleMapBtn = $('#toggleMapSize');    const mapOverlay = $('#mapOverlay');    const streetViewFrame = $('#streetViewFrame');    const streetViewHint = $('#streetViewHint');    const mapInstruction = $('#mapInstruction');    const openStreetViewBtn = $('#openStreetViewBtn');    const historyBody = #historyBody;    const modeButtons = ('.mode-btn');    let latestSearchResult = null;    const setSavePermitStatus = (msg, isError = false) => { if (!savePermitStatus) return; savePermitStatus.textContent = msg || ''; savePermitStatus.style.color = isError ? '#ff9e9e' : '#9fb3c7'; };    const resetPermitSave = () => { latestSearchResult = null; if (savePermitBtn) { savePermitBtn.setAttribute('disabled', 'true'); } if (savePermitStatus) { setSavePermitStatus(''); } };    let pickerMap;    let pickerMarker;    let drawnItems;    let drawControl;    let drawControlActive = false;    let polygonCoords = null;    resetPermitSave();    let selectionMode = 'point';    let streetViewUrl = null;    const polygonCentroid = (coords) => {      if (!Array.isArray(coords) || coords.length < 3) return null;      let twiceArea = 0;      let cx = 0;      let cy = 0;      for (let i = 0; i < coords.length; i += 1) {        const [lat1, lon1] = coords[i];        const [lat2, lon2] = coords[(i + 1) % coords.length];        const cross = lon1 * lat2 - lon2 * lat1;        twiceArea += cross;        cx += (lon1 + lon2) * cross;        cy += (lat1 + lat2) * cross;      }      if (Math.abs(twiceArea) < 1e-9) {        const avg = coords.reduce((acc, pair) => [acc[0] + pair[0], acc[1] + pair[1]], [0, 0]);        return { lat: avg[0] / coords.length, lon: avg[1] / coords.length };      }      const area = twiceArea * 0.5;      return { lat: cy / (6 * area), lon: cx / (6 * area) };    };    const clearPolygon = () => {      polygonCoords = null;      if (drawnItems) {        drawnItems.clearLayers();      }    };    const extractPolygonCoords = (layer) => {      if (!layer) return null;      const latlngs = layer.getLatLngs();      const ring = Array.isArray(latlngs) ? (Array.isArray(latlngs[0]) ? latlngs[0] : latlngs) : [];      if (!Array.isArray(ring) || ring.length < 3) return null;      return ring.map((ll) => [Number(ll.lat), Number(ll.lng)]);    };    const updateModeButtons = () => {      if (!modeButtons) return;      modeButtons.forEach((btn) => {        if (!btn) return;        btn.classList.toggle('active', btn.dataset.mode === selectionMode);      });    };    const setSelectionMode = (mode) => {      selectionMode = mode === 'polygon' ? 'polygon' : 'point';      updateModeButtons();      if (mapInstruction) {        mapInstruction.textContent = selectionMode === 'polygon' ? 'Draw a polygon to define the search area' : 'Click map to set search origin';      }      if (!pickerMap) return;      if (selectionMode === 'point') {        if (drawControl && drawControlActive) {          pickerMap.removeControl(drawControl);          drawControlActive = false;        }        clearPolygon();        if (!pickerMarker) {          pickerMarker = L.marker(pickerMap.getCenter(), { draggable: false });        }        if (!pickerMarker._map) {          pickerMarker.addTo(pickerMap);        }      } else {        if (pickerMarker && pickerMarker._map) {          pickerMap.removeLayer(pickerMarker);        }        if (drawControl && !drawControlActive) {          pickerMap.addControl(drawControl);          drawControlActive = true;        }      }    };    if (modeButtons && modeButtons.length) {      modeButtons.forEach((btn) => {        btn.addEventListener('click', () => {          setSelectionMode(btn.dataset.mode);          if (selectionMode === 'point') {            const coords = parseLocation(locationEl.value);            if (coords) {              updatePickerMarker(coords);            }          }        });      });    }    updateModeButtons();    const setMapExpanded = (expanded) => {      if (mapPreview) {        mapPreview.classList.toggle('expanded', expanded);      }      if (toggleMapBtn) {        toggleMapBtn.textContent = expanded ? 'Close map' : 'Enlarge map';      }      if (mapOverlay) {        mapOverlay.classList.toggle('visible', expanded);      }      document.body.classList.toggle('no-scroll', expanded);    };    const updateStreetView = (coords) => {      if (!streetViewFrame) return;      if (coords && Number.isFinite(coords.lat) && Number.isFinite(coords.lon)) {        const { lat, lon } = coords;        const embedUrl = `https://www.google.com/maps?q=&layer=c&cbll=${lat},${lon}&cbp=11,0,0,0,0&z=18&output=svembed`;        streetViewFrame.src = embedUrl;        streetViewUrl = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lon}`;        if (streetViewHint) {          streetViewHint.textContent = 'Use Street View to explore the surroundings of the permit location.';        }        if (openStreetViewBtn) {          openStreetViewBtn.disabled = false;          openStreetViewBtn.onclick = () => window.open(streetViewUrl, '_blank', 'noopener');        }      } else {        streetViewFrame.src = 'about:blank';        streetViewUrl = null;        if (streetViewHint) {          streetViewHint.textContent = 'Street View appears once a search returns a location.';        }        if (openStreetViewBtn) {          openStreetViewBtn.disabled = true;          openStreetViewBtn.onclick = null;        }      }    };    updateStreetView(null);    if (toggleMapBtn) {      toggleMapBtn.addEventListener('click', () => {        const expanded = mapPreview?.classList.contains('expanded');        setMapExpanded(!expanded);      });    }    if (mapOverlay) {      mapOverlay.addEventListener('click', () => setMapExpanded(false));    }    window.addEventListener('keyup', (event) => {      if (event.key === 'Escape') {        setMapExpanded(false);      }    });    const setOutcomeBadge = (level = 'LOW') => {      const lvl = String(level || 'LOW').toUpperCase();      outcomeBadge.classList.remove('badge-low', 'badge-medium', 'badge-high');      outcomeBadge.classList.add(lvl === 'HIGH' ? 'badge-high' : lvl === 'MEDIUM' ? 'badge-medium' : 'badge-low');      text(outcomeBadge, lvl);    };    const selectedCategories = () =>      $$("input[type='checkbox'][name='cat']").filter((box) => box.checked).map((box) => box.dataset.cat || box.value);    const renderSummaryTable = (items = []) => {      if (!Array.isArray(items) || items.length === 0) {        html(detailsBody, "<tr><td class='muted' colspan='5'>No nearby features found.</td></tr>");        return;      }      const rows = items.map((row) => `        <tr>          <td>${row.label ?? '-'}</td>          <td>${row.no ? 'X' : ''}</td>          <td>${row.lt10 ? 'X' : ''}</td>          <td>${row.r10_25 ? 'X' : ''}</td>          <td>${row.r25_100 ? 'X' : ''}</td>        </tr>      `).join('');      html(detailsBody, rows);    };    const parseLocation = (value) => {      if (!value) return null;      if (value.startsWith('///')) return null;      const cleaned = value.replace(/\s+/g, '');      const parts = cleaned.split(',');      if (parts.length !== 2) return null;      const lat = parseFloat(parts[0]);      const lon = parseFloat(parts[1]);      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;      return [lat, lon];    };    const initialisePickerMap = () => {      if (typeof window.L === 'undefined') {        console.warn('Leaflet library not available; picker map disabled.');        return;      }      const defaultCenter = [54.5973, -5.9301];      const parsed = parseLocation(locationEl.value);      const center = parsed || defaultCenter;      pickerMap = L.map('pickerMap', { zoomControl: true }).setView(center, 15);      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {        attribution: '&copy; OpenStreetMap contributors'      }).addTo(pickerMap);      drawnItems = new L.FeatureGroup();      pickerMap.addLayer(drawnItems);      drawControlActive = false;      if (L.Control && L.Control.Draw) {        drawControl = new L.Control.Draw({          draw: {            marker: false,            polyline: false,            rectangle: false,            circle: false,            circlemarker: false,            polygon: { allowIntersection: false, showArea: true, shapeOptions: { color: '#2b7cff' } },          },          edit: { featureGroup: drawnItems, remove: true },        });      } else {        console.warn('Leaflet.draw plugin missing; polygon mode disabled.');        drawControl = null;      }      pickerMarker = L.marker(center, { draggable: false }).addTo(pickerMap);      pickerMap.on('click', (event) => {        if (selectionMode !== 'point') return;        const { lat, lng } = event.latlng;        locationEl.value = `${lat.toFixed(6)},${lng.toFixed(6)}`;        updatePickerMarker([lat, lng]);      });      if (L.Draw && L.Draw.Event) {        pickerMap.on(L.Draw.Event.CREATED, (event) => {          if (selectionMode !== 'polygon') return;          clearPolygon();          drawnItems.addLayer(event.layer);          polygonCoords = extractPolygonCoords(event.layer);          if (polygonCoords && polygonCoords.length >= 3) {            const centroid = polygonCentroid(polygonCoords);            if (centroid) {              locationEl.value = `${centroid.lat.toFixed(6)},${centroid.lon.toFixed(6)}`;              pickerMap.setView([centroid.lat, centroid.lon]);            }          }        });        pickerMap.on(L.Draw.Event.EDITED, (event) => {          if (selectionMode !== 'polygon') return;          let newCoords = null;          event.layers.eachLayer((layer) => {            newCoords = extractPolygonCoords(layer);          });          polygonCoords = newCoords;          if (polygonCoords && polygonCoords.length >= 3) {            const centroid = polygonCentroid(polygonCoords);            if (centroid) {              locationEl.value = `${centroid.lat.toFixed(6)},${centroid.lon.toFixed(6)}`;              pickerMap.setView([centroid.lat, centroid.lon]);            }          }        });        pickerMap.on(L.Draw.Event.DELETED, () => {          if (selectionMode !== 'polygon') return;          clearPolygon();          locationEl.value = '';        });      }      setSelectionMode(selectionMode);    };    const updatePickerMarker = (coords) => {      if (!coords || !Array.isArray(coords)) return;      const lat = coords[0];      const lon = coords[1];      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;      if (pickerMarker) {        pickerMarker.setLatLng([lat, lon]);        if (selectionMode === 'point' && pickerMap && !pickerMarker._map) {          pickerMarker.addTo(pickerMap);        }      }      if (pickerMap) {        pickerMap.setView([lat, lon]);      }    };    const renderHistory = (items) => {      if (!historyBody) return;      if (!items || items.length === 0) {        historyBody.innerHTML = "<tr><td class='muted' colspan='3'>No history yet.</td></tr>";        return;      }      const rows = items.map((row) => {        const whenRaw = row.timestamp || '';        const whenDate = whenRaw ? new Date(whenRaw) : null;        const formatted = whenDate && !Number.isNaN(whenDate.getTime())          ? `${whenDate.getDate().toString().padStart(2, '0')}/${(whenDate.getMonth() + 1).toString().padStart(2, '0')}/${(whenDate.getFullYear() % 100).toString().padStart(2, '0')}, ${whenDate.toLocaleTimeString('en-GB', { hour12: false })}`          : whenRaw;        const loc = row.location || '';        const outcomeRaw = (row.outcome || '').toString().toUpperCase();        const outcomeClass = outcomeRaw === 'HIGH' ? 'history-high' : outcomeRaw === 'MEDIUM' ? 'history-medium' : 'history-low';        return `<tr><td>${formatted}</td><td>${loc}</td><td><span class="${outcomeClass}">${outcomeRaw}</span></td></tr>`;      }).join('');      historyBody.innerHTML = rows;    };    const fetchHistory = async () => {      try {        const res = await fetch('/api/history', { credentials: 'include' });        if (res.status === 401) {          window.location.href = '/';          return;        }        const data = await res.json();        renderHistory(Array.isArray(data.history) ? data.history : []);      } catch (err) {        console.error('Failed to load history', err);      }    };    const extractStreetCoords = (summary, result) => {      if (summary && summary.center_coords) {        const { lat, lon } = summary.center_coords;        if (Number.isFinite(lat) && Number.isFinite(lon)) {          return { lat, lon };        }      }      const details = result?.details_100m;      if (Array.isArray(details) && details.length > 0) {        const first = details[0];        const lat = Number(first.lat ?? (Array.isArray(first) ? first[3] : null));        const lon = Number(first.lon ?? (Array.isArray(first) ? first[4] : null));        if (Number.isFinite(lat) && Number.isFinite(lon)) {          return { lat, lon };        }      }      return null;    };    async function runSearch() {      try {        showError('');        resetPermitSave();        if (selectionMode === 'polygon' && (!polygonCoords || polygonCoords.length < 3)) {          showError('Draw a polygon on the map before running the search.');          return;        }        const payload = {          location: (locationEl.value || '').trim(),          radius_m: parseInt(radiusEl.value, 10) || 500,          categories: selectedCategories(),          permit: (permitEl.value || '').trim() || null,          max_results: null,          selection_mode: selectionMode,          polygon: selectionMode === 'polygon' && Array.isArray(polygonCoords) && polygonCoords.length >= 3 ? polygonCoords : null,        };        const res = await fetch('/api/search', {          method: 'POST',          headers: { 'Content-Type': 'application/json' },          credentials: 'include',          body: JSON.stringify(payload),        });        const json = await res.json().catch(() => ({}));        if (res.status === 401) {          window.location.href = '/';          return;        }        if (!res.ok) {          showError(json?.error || `Request failed (${res.status})`);          console.error('API error', json);          updateStreetView(null);          return;        }        if (json.status !== 'done' || !json.result) {          showError(json?.error || 'Search failed.');          console.error('Unexpected response', json);          updateStreetView(null);          return;        }        const result = json.result || {};        const summary = result.summary || {};        const artifacts = result.artifacts || {};        latestSearchResult = result;        const hasPermitRef = !!(permitEl && (permitEl.value || '').trim());        if (savePermitBtn) {          if (hasPermitRef) {            savePermitBtn.removeAttribute('disabled');          } else {            savePermitBtn.setAttribute('disabled', 'true');          }        }        setSavePermitStatus(hasPermitRef ? 'Ready to save permit record.' : 'Add a permit number to save this search.');        setOutcomeBadge(summary.outcome || 'LOW');        text(centerLabel, summary.center || '');        text(radiusLabel, summary.radius ? `Radius: ${summary.radius} m` : '');        text(permitLabel, summary.permit ? `Permit: ${summary.permit}` : '');        renderSummaryTable(summary.categories || []);        if (summary.center_coords) {          updatePickerMarker([summary.center_coords.lat, summary.center_coords.lon]);        }        fetchHistory();        const pdfUrl = artifacts.pdf_url || artifacts.pdf_download_url || null;        if (pdfUrl) {          downloadBtn.href = pdfUrl;          downloadBtn.removeAttribute('disabled');        } else {          downloadBtn.setAttribute('disabled', 'true');          downloadBtn.removeAttribute('href');        }        const mapUrl = artifacts.map_url || artifacts.map_embed_url || null;        if (mapUrl) {          if (mapFrame) {            mapFrame.src = mapUrl;          }          openMapBtn.removeAttribute('disabled');          openMapBtn.onclick = () => window.open(mapUrl, '_blank', 'noopener');        } else {          if (mapFrame) {            mapFrame.src = 'about:blank';          }          openMapBtn.setAttribute('disabled', 'true');          openMapBtn.onclick = null;          setMapExpanded(false);        }        const coords = extractStreetCoords(summary, result);        updateStreetView(coords);      } catch (err) {        console.error(err);        showError(err?.message || 'Unexpected error');        updateStreetView(null);        setMapExpanded(false);      }    }    async function savePermitRecord() {      if (!permitEl || !savePermitBtn) return;      const permitRef = (permitEl.value || '').trim();      if (!permitRef) {        setSavePermitStatus('Enter a permit number before saving.', true);        return;      }      if (!latestSearchResult) {        setSavePermitStatus('Run a search before saving.', true);        return;      }      setSavePermitStatus('Saving...', false);      savePermitBtn.setAttribute('disabled', 'true');      try {        const res = await fetch('/api/permits', {          method: 'POST',          headers: { 'Content-Type': 'application/json' },          credentials: 'include',          body: JSON.stringify({ permit_ref: permitRef, result: latestSearchResult }),        });        const json = await res.json().catch(() => ({}));        if (res.status === 401) {          window.location.href = '/';          return;        }        if (!res.ok) {          const message = json?.detail || json?.error || 'Failed to save permit record.';          setSavePermitStatus(message, true);          savePermitBtn.removeAttribute('disabled');          return;        }        if (json?.search_result) {          latestSearchResult = json.search_result;        }        setSavePermitStatus('Permit record saved.', false);        savePermitBtn.removeAttribute('disabled');      } catch (err) {        console.error('Failed to save permit', err);        setSavePermitStatus('Unable to save permit record.', true);        savePermitBtn.removeAttribute('disabled');      }    }    document.addEventListener('DOMContentLoaded', () => {      initialisePickerMap();      const initialCoords = parseLocation(locationEl.value);      if (initialCoords) {        updatePickerMarker(initialCoords);      }    });    fetch('/auth-status', { credentials: 'include' })      .then((res) => {        if (res.status === 401) {          window.location.href = '/';          return;        }        fetchHistory();      })      .catch(() => {});    if (permitEl) {      permitEl.addEventListener('input', () => {        if (!savePermitBtn) return;        const hasPermitRef = !!(permitEl.value || '').trim();        if (!latestSearchResult) {          savePermitBtn.setAttribute('disabled', 'true');          setSavePermitStatus(hasPermitRef ? 'Run the search to enable saving.' : '');          return;        }        if (hasPermitRef) {          savePermitBtn.removeAttribute('disabled');          setSavePermitStatus('Ready to save permit record.');        } else {          savePermitBtn.setAttribute('disabled', 'true');          setSavePermitStatus('Add a permit number to save this search.');        }      });    }    if (savePermitBtn) { savePermitBtn.addEventListener('click', savePermitRecord); }    runBtn.addEventListener('click', runSearch);    locationEl.addEventListener('keydown', (event) => {      if (event.key === 'Enter') {        event.preventDefault();        runSearch();      }    });  })();  </script></body></html>

