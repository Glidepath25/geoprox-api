<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GeoProx — Proximity Checker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0f1720;
      --panel: #0b1b2a;
      --panel-2: #0f2436;
      --text: #d9e3ea;
      --muted: #9fb3c8;
      --brand: #2ea1ff;
      --accent: #195a8f;
      --ok: #2e7d32;
      --medium: #ef6c00;
      --high: #c62828;
      --row: #0c1f30;
      --row-alt: #0b1b2a;
      --tick: #a78bfa;
      --border: #16364f;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; color: var(--text); background: var(--bg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    a { color: var(--brand); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .wrap { max-width: 1200px; margin: 28px auto; padding: 0 16px; }
    .header { display:flex; align-items:center; gap:12px; margin-bottom:18px; }
    .logo { width: 30px; height: 30px; display:inline-block; background: url("/static/geoprox-logo.png") center / cover no-repeat; border-radius: 6px; }
    .title { font-size: 22px; font-weight: 700; }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
    .row { display:flex; gap:14px; flex-wrap:wrap; }
    .col { flex:1 1 300px; min-width: 260px; }
    label.small { display:block; color: var(--muted); font-size: 12px; margin-bottom: 6px; }
    input[type="text"], input[type="number"] {
      width: 100%; background: var(--panel-2); border: 1px solid var(--border);
      color: var(--text); padding: 10px 12px; border-radius: 8px; outline: none;
    }
    input[type="text"]::placeholder { color: #6b89a6; }
    .cats { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 10px 18px; margin-top: 12px; }
    .cats label { display:flex; align-items:center; gap:8px; user-select:none; cursor: pointer; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center;
      padding: 9px 14px; border-radius: 8px; border: 1px solid var(--accent);
      background: #0e2a42; color: var(--text); font-weight: 600; cursor: pointer;
    }
    .btn:hover { background:#0f3454; }
    .btn.ghost { border-color: var(--border); background:#0c2233; }
    .btn.ghost:hover { background:#0d2a40; }
    .spacer { height: 14px; }
    .grid-2 { display:grid; grid-template-columns: 2fr 1.3fr; gap: 16px; }
    @media (max-width: 1020px){ .grid-2 { grid-template-columns: 1fr; } }
    .badge {
      display:inline-block; padding: 4px 10px; border-radius: 999px; font-weight: 700; font-size: 12px;
      border: 1px solid var(--border);
    }
    .low { background: #072012; border-color:#184424; color:#9ce6b1; }
    .med { background: #251705; border-color:#4c2c08; color:#ffce8a; }
    .high { background: #2a0b0b; border-color:#5a1717; color:#ff9a9a; }
    .muted { color: var(--muted); font-size: 13px; }
    .table-scroll { overflow:auto; border: 1px solid var(--border); border-radius: 8px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; }
    thead th {
      position: sticky; top:0; z-index:2;
      background: #0a2133; color: var(--muted); border-bottom: 1px solid var(--border);
      text-align:left; font-weight: 700; font-size: 13px;
    }
    tbody tr:nth-child(odd) { background: var(--row); }
    tbody tr:nth-child(even){ background: var(--row-alt); }
    td { border-bottom: 1px solid #0f2b42; font-size: 14px; }
    .check { color: var(--tick); font-weight: 800; font-size: 16px; }
    .right { text-align:right; }
    .actions { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .mapbox { background:#071a28; border:1px solid var(--border); border-radius: 10px; height: 420px; overflow:hidden; }
    .mapbox iframe { width: 100%; height: 100%; border: 0; background:#071a28; }
    .rowline { display:flex; justify-content:space-between; align-items:center; gap: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="logo"></div>
      <div class="title">GeoProx — Proximity Checker</div>
    </div>

    <div class="panel">
      <div class="row">
        <div class="col">
          <label class="small">Location (lat,lon e.g. <code>54.5973,-5.9301</code>), or <code>//what.three.words</code></label>
          <input id="fld-location" type="text" placeholder="54.5973,-5.9301" />
        </div>
        <div class="col">
          <label class="small">Radius (metres)</label>
          <input id="fld-radius" type="number" value="2000" min="10" max="20000" />
        </div>
      </div>

      <div class="spacer"></div>

      <div class="row">
        <div class="col">
          <label class="small">Permit number (optional)</label>
          <input id="fld-permit" type="text" placeholder="K6001-DAF-ACON-12345" />
        </div>
        <div class="col" style="display:flex; align-items:flex-end;">
          <button id="btn-run" class="btn">Run search</button>
        </div>
      </div>

      <div class="spacer"></div>

      <label class="small">Categories to search (leave all unchecked to search all)</label>
      <div class="cats">
        <!-- values match server-side OSM_FILTERS keys (safe to leave empty) -->
        <label><input type="checkbox" class="cat" value="manufacturing" checked> Industrial / Manufacturing</label>
        <label><input type="checkbox" class="cat" value="gas_holding" checked> Gas holder stations</label>
        <label><input type="checkbox" class="cat" value="mines" checked> Mining (coal, metalliferous)</label>
        <label><input type="checkbox" class="cat" value="petrol_stations" checked> Petrol stations / Garages</label>
        <label><input type="checkbox" class="cat" value="sewage_treatment" checked> Sewage Treatment Works</label>
        <label><input type="checkbox" class="cat" value="substations" checked> Sub-Stations</label>
        <label><input type="checkbox" class="cat" value="landfills" checked> Waste Site – Landfill & Treatment / Disposal</label>
        <label><input type="checkbox" class="cat" value="scrapyards" checked> Waste Site – Scrapyard / Metal Recycling</label>
        <label><input type="checkbox" class="cat" value="waste_disposal" checked> Waste Site – Other</label>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="grid-2">
      <div class="panel">
        <div class="rowline">
          <div>
            <span class="muted">Outcome:</span>
            <span id="badge" class="badge low">LOW</span>
            <div id="meta" class="muted" style="margin-top:6px;"></div>
          </div>
          <div class="actions">
            <a id="btn-pdf" href="#" target="_blank" class="btn">Download PDF</a>
            <a id="btn-map" href="#" target="_blank" class="btn ghost">Open Map</a>
          </div>
        </div>

        <div class="spacer"></div>

        <div class="table-scroll">
          <table id="tbl">
            <thead>
              <tr>
                <th>Category</th>
                <th class="right">No</th>
                <th class="right">&lt;10m</th>
                <th class="right">10–25m</th>
                <th class="right">25–100m</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <!-- rows inserted by JS -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <div class="mapbox">
          <iframe id="map-iframe" title="GeoProx Map"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script>
    const elLoc = document.getElementById('fld-location');
    const elRad = document.getElementById('fld-radius');
    const elPermit = document.getElementById('fld-permit');
    const elBtn = document.getElementById('btn-run');
    const elBadge = document.getElementById('badge');
    const elMeta = document.getElementById('meta');
    const elTbody = document.getElementById('tbody');
    const elBtnPdf = document.getElementById('btn-pdf');
    const elBtnMap = document.getElementById('btn-map');
    const elFrame = document.getElementById('map-iframe');

    function outcomeFromSummary(summary) {
      // Compute outcome (LOW/MEDIUM/HIGH) the same way your PDF does
      if (!summary) return "LOW";
      // HIGH if any category has <10m > 0
      for (const cat of Object.values(summary)) {
        if ((cat["<10m"] || 0) > 0) return "HIGH";
      }
      // MEDIUM if any category has 10–25m > 0
      for (const cat of Object.values(summary)) {
        if ((cat["10–25m"] || 0) > 0) return "MEDIUM";
      }
      return "LOW";
    }

    function setOutcomeBadge(level) {
      elBadge.classList.remove('low', 'med', 'high');
      if (level === 'HIGH') elBadge.classList.add('high');
      else if (level === 'MEDIUM') elBadge.classList.add('med');
      else elBadge.classList.add('low');
      elBadge.textContent = level;
    }

    function tickIf(v) { return v > 0 ? '<span class="check">✔</span>' : ''; }

    function buildRows(summary) {
      elTbody.innerHTML = '';
      if (!summary || Object.keys(summary).length === 0) return;

      for (const [name, bins] of Object.entries(summary)) {
        const has10  = (bins["<10m"] || 0) > 0;
        const has25  = (bins["10–25m"] || 0) > 0;
        const has100 = (bins["25–100m"] || 0) > 0;
        const noneWithin100 = !(has10 || has25 || has100);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${name}</td>
          <td class="right">${noneWithin100 ? '<span class="check">✔</span>' : ''}</td>
          <td class="right">${tickIf(bins["<10m"] || 0)}</td>
          <td class="right">${tickIf(bins["10–25m"] || 0)}</td>
          <td class="right">${tickIf(bins["25–100m"] || 0)}</td>
        `;
        elTbody.appendChild(tr);
      }
    }

    function artifactUrl(art, ...keys) {
      for (const k of keys) {
        if (art && art[k]) return art[k];
      }
      return null;
    }

    async function runSearch() {
      elBtn.disabled = true;
      elBtn.textContent = "Searching…";

      try {
        const cats = Array.from(document.querySelectorAll('.cat:checked')).map(c => c.value);

        const resp = await fetch('/api/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            location: elLoc.value.trim(),
            radius_m: parseInt(elRad.value, 10) || 2000,
            categories: cats,        // empty array is fine (server searches all)
            permit: elPermit.value.trim() || null
          })
        });

        if (!resp.ok) {
          const t = await resp.text();
          throw new Error(`Search failed: ${resp.status} ${t}`);
        }

        const data = await resp.json();
        const result = data.result || {};
        const center = result.center || {};
        const summary = result.summary_bins || {};
        const arts = result.artifacts || {};

        // outcome
        setOutcomeBadge(outcomeFromSummary(summary));

        // meta
        const lat = (center.lat ?? '').toFixed ? center.lat.toFixed(6) : center.lat;
        const lon = (center.lon ?? '').toFixed ? center.lon.toFixed(6) : center.lon;
        elMeta.innerHTML = `Search center: ${lat}, ${lon} — Radius: ${result.radius_m || ''} m`;

        // table
        buildRows(summary);

        // links
        const pdf = artifactUrl(arts, 'pdf_download_url', 'pdf_url');
        elBtnPdf.style.display = pdf ? 'inline-flex' : 'none';
        if (pdf) elBtnPdf.href = pdf;

        const mapUrl = artifactUrl(arts, 'map_embed_url', 'map_html_url', 'map_url');
        elBtnMap.style.display = mapUrl ? 'inline-flex' : 'none';
        if (mapUrl) elBtnMap.href = mapUrl;

        // embed map (same URL works if the server serves it from /artifacts/*)
        if (mapUrl) {
          elFrame.src = mapUrl;
        } else {
          elFrame.removeAttribute('src');
        }

      } catch (err) {
        alert(err.message || err);
      } finally {
        elBtn.disabled = false;
        elBtn.textContent = "Run search";
      }
    }

    document.getElementById('btn-run').addEventListener('click', runSearch);

    // Convenience: a little Belfast default so it's not empty on first load
    elLoc.value = "54.5973,-5.9301";
  </script>
</body>
</html>
